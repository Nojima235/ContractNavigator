<!-- =========================
     ConsultingNavigator.html
     ========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>コンサルツール</title>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      margin:0;background:#f6f7f9;color:#111;font-size:17px;
    }
    .wrap{max-width:960px;margin:0 auto;padding:16px;}
    .card{background:#fff;border:1px solid #e6e8eb;border-radius:14px;padding:16px;}
    h1{font-size:20px;margin:0 0 8px;}
    p{margin:0;color:#555;}
    .divider{height:1px;background:#eef0f3;margin:12px 0;}
    label{font-size:16px;color:#333;}
    select{
      width:100%;padding:14px 12px;border-radius:10px;border:1px solid #d9dde3;
      font-size:17px;background:#fff;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
    .btn2{
      border:1px solid #d9dde3;background:#fff;color:#111;border-radius:12px;
      padding:14px 16px;font-size:16px;cursor:pointer;
    }
    .hidden{display:none !important;}
    .hint{font-size:14px;color:#555;margin-top:8px;line-height:1.45;}
    .note{
      background:#f6fbff;border:1px solid #d6e8ff;border-radius:12px;padding:10px 12px;
      color:#234; font-size:14px; line-height:1.45;
    }
    .alert{
      background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:10px 12px;margin-top:10px;
      color:#b00020;font-size:15px;font-weight:800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>コンサルツール</h1>
      <p>プラン提案の分岐・比較表などを追加していきます。</p>

      <div class="divider"></div>

      <!-- 端末あり（機変/MNP端末あり）のとき-->
      <div id="payTypeBlock" class="hidden">
        <label>端末の購入方法（支払い）</label>
        <select id="payType">
          <option value="" selected>未選択</option>
          <option value="nojimaInstall" id="optNojimaInstall">分リセ</option>
          <option value="carrierInstall">キャリアの分割</option>
          <option value="lump">一括</option>
        </select>
      </div>

      <!-- SIMのみのとき -->
      <div id="simOnlyNote" class="hidden">
        <div class="note">
          SIMのみ（端末なし）のため、データ移行・下取り受付は基本発生しません。
        </div>
      </div>

      <div class="divider"></div>

      <!-- 端末ありのときだけ表示（SIMのみは弾く） -->
      <div id="dataTransferBlock">
        <label>データ移行の有無</label>
        <select id="needDataTransfer">
          <option value="yes">あり</option>
          <option value="no" selected>なし</option>
        </select>
      </div>

      <div style="margin-top:12px;" id="tradeInReceptionBlock">
        <label>下取り受付の有無</label>
        <select id="needTradeInReception">
          <option value="yes">あり</option>
          <option value="no" selected>なし</option>
        </select>
      </div>

      <div class="alert hidden" id="pointAlert"></div>

      <div class="row">
        <button class="btn2" id="backToContractBtn">← 契約ナビに戻る</button>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = "contract_navi_ctx_v2_multi";
const el = (id) => document.getElementById(id);

function readShared(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return {};
  try { return JSON.parse(raw) || {}; } catch(e){ return {}; }
}
function writeSharedAll(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  return obj;
}

/* 端末が関係する契約かどうか（= payType / データ移行 / 下取りの対象） */
function needsDeviceFlow(ct){
  return ct === "deviceChange" || ct === "mnpDevice";
}

/* ★ activeLine / line を安全に取り出す */
function getActiveLine(shared){
  const lines = Array.isArray(shared.lines) ? shared.lines : [];
  const active = Number.isFinite(shared.activeLine) ? shared.activeLine : 0;
  const idx = Math.max(0, Math.min(active, Math.max(0, lines.length - 1)));
  const line = lines[idx] || { form:{}, consult:{ payType:"", needDataTransfer:"no", needTradeInReception:"no" }, flow:{} };
  return { idx, line, lines };
}

function updatePointAlert(){
  const box = el("pointAlert");
  if (!box) return;

  const shared = readShared();
  const { line } = getActiveLine(shared);
  const ct = line?.form?.contractType || "";
  const deviceFlow = needsDeviceFlow(ct);

  // 端末なし（SIMのみ）なら対象外
  if (!deviceFlow){
    box.classList.add("hidden");
    box.textContent = "";
    return;
  }

  const payType = (el("payType") ? el("payType").value : "") || (line.consult?.payType || "");
  const tradeIn = (el("needTradeInReception") ? el("needTradeInReception").value : "no") || (line.consult?.needTradeInReception || "no");

  const isCarrierOrLump = (payType === "carrierInstall" || payType === "lump");
  const noTradeIn = (tradeIn === "no");

  if (isCarrierOrLump && noTradeIn){
    box.textContent = "【注意】購入方法が「分リセ以外」かつ「下取りなし」の場合、ポイント付与ができません。下取り受付をご確認ください。";
    box.classList.remove("hidden");
  } else {
    box.classList.add("hidden");
    box.textContent = "";
  }
}

(function init(){
  const shared = readShared();
  const { line } = getActiveLine(shared);
  const ct = line?.form?.contractType || "";

  const deviceFlow = needsDeviceFlow(ct);
  const isDeviceChange = (ct === "deviceChange");

  // payType：端末ありだけ表示
  if (el("payTypeBlock")) el("payTypeBlock").classList.toggle("hidden", !deviceFlow);

  // SIMのみ（端末なし）メモ
  if (el("simOnlyNote")) el("simOnlyNote").classList.toggle("hidden", deviceFlow);

  // データ移行 / 下取り：端末ありだけ表示
  if (el("dataTransferBlock")) el("dataTransferBlock").classList.toggle("hidden", !deviceFlow);
  if (el("tradeInReceptionBlock")) el("tradeInReceptionBlock").classList.toggle("hidden", !deviceFlow);

  // ★ 機種変更は「分リセ」を選べない
  if (deviceFlow && isDeviceChange){
    const opt = el("optNojimaInstall");
    if (opt){
      opt.disabled = true;
      opt.textContent = "分リセ ※機種変更では選択不可";
    }
    // 既に分リセが入ってたら解除
    if ((line.consult?.payType || shared.payType || "") === "nojimaInstall"){
      if (el("payType")) el("payType").value = "";
      // storage側も解除しておく
      const s = readShared();
      const t = getActiveLine(s);
      t.line.consult = t.line.consult || {};
      t.line.consult.payType = "";
      s.lines[t.idx] = t.line;
      // 互換トップレベルも念のため
      s.payType = "";
      writeSharedAll(s);
    }
  }

  // 初期値復元（consultは lines 優先、トップレベル互換）
  const consult = line.consult || {};
  const payType = consult.payType ?? shared.payType ?? "";
  const needDataTransfer = consult.needDataTransfer ?? shared.needDataTransfer ?? "no";
  const needTradeInReception = consult.needTradeInReception ?? shared.needTradeInReception ?? "no";

  if (deviceFlow){
    if (el("payType")) el("payType").value = payType || "";
    if (el("needDataTransfer")) el("needDataTransfer").value = needDataTransfer;
    if (el("needTradeInReception")) el("needTradeInReception").value = needTradeInReception;
  } else {
    // SIMのみは固定
    if (el("payType")) el("payType").value = "";
    if (el("needDataTransfer")) el("needDataTransfer").value = "no";
    if (el("needTradeInReception")) el("needTradeInReception").value = "no";

    const s = readShared();
    const t = getActiveLine(s);
    t.line.consult = { payType:"", needDataTransfer:"no", needTradeInReception:"no" };
    s.lines[t.idx] = t.line;
    s.payType = "";
    s.needDataTransfer = "no";
    s.needTradeInReception = "no";
    writeSharedAll(s);
    updatePointAlert();
  }
})();

/* ★ consult の保存は lines[activeLine].consult に書く（トップレベル互換も同時更新） */
function saveConsultPatch(patch){
  const s = readShared();
  const t = getActiveLine(s);
  t.line.consult = { ...(t.line.consult || {}), ...patch };
  s.lines = Array.isArray(s.lines) ? s.lines : [];
  s.lines[t.idx] = t.line;

  // 互換（古い読み方でも動くように）
  if ("payType" in patch) s.payType = patch.payType;
  if ("needDataTransfer" in patch) s.needDataTransfer = patch.needDataTransfer;
  if ("needTradeInReception" in patch) s.needTradeInReception = patch.needTradeInReception;

  writeSharedAll(s);
}

if (el("payType")){
  el("payType").addEventListener("change", () => {
    const s = readShared();
    const t = getActiveLine(s);
    const ct = (t.line.form && t.line.form.contractType) ? t.line.form.contractType : (s.contractType || "");

    // 機変で分リセ禁止
    if (ct === "deviceChange" && el("payType").value === "nojimaInstall"){
      el("payType").value = "";
      saveConsultPatch({ payType: "" });
      return;
    }
    saveConsultPatch({ payType: el("payType").value });
    updatePointAlert();
  });
}
if (el("needDataTransfer")){
  el("needDataTransfer").addEventListener("change", () => {
    saveConsultPatch({ needDataTransfer: el("needDataTransfer").value });
  });
}
if (el("needTradeInReception")){
  el("needTradeInReception").addEventListener("change", () => {
    saveConsultPatch({ needTradeInReception: el("needTradeInReception").value });
    updatePointAlert();
  });
}

// 戻るボタン：押した瞬間に保存して戻る
if (el("backToContractBtn")){
  el("backToContractBtn").onclick = () => {
    const s = readShared();
    const t = getActiveLine(s);
    const ct = (t.line.form && t.line.form.contractType) ? t.line.form.contractType : (s.contractType || "");
    const deviceFlow = needsDeviceFlow(ct);

    if (deviceFlow){
      saveConsultPatch({
        payType: el("payType") ? el("payType").value : "",
        needDataTransfer: el("needDataTransfer") ? el("needDataTransfer").value : "no",
        needTradeInReception: el("needTradeInReception") ? el("needTradeInReception").value : "no"
      });
    } else {
      saveConsultPatch({ payType:"", needDataTransfer:"no", needTradeInReception:"no" });
    }

    window.location.href = "ContractNavigator.html";
  };
}
</script>
</body>
</html>