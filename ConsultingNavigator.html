<!-- =========================
     ConsultingNavigator.html
     ========================= -->
<!-- 作成者：ノジマ　マルエツ稲毛店　駒 諒大 -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>コンサルツール</title>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      margin:0;background:#f6f7f9;color:#111;font-size:17px;
    }
    .wrap{max-width:960px;margin:0 auto;padding:16px;}
    .card{background:#fff;border:1px solid #e6e8eb;border-radius:14px;padding:16px;}
    h1{font-size:20px;margin:0 0 8px;}
    p{margin:0;color:#555;}
    .divider{height:1px;background:#eef0f3;margin:12px 0;}
    label{font-size:16px;color:#333;}
    select{
      width:100%;padding:14px 12px;border-radius:10px;border:1px solid #d9dde3;
      font-size:17px;background:#fff;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
    .btn2{
      border:1px solid #d9dde3;background:#fff;color:#111;border-radius:12px;
      padding:14px 16px;font-size:16px;cursor:pointer;
    }
    .hidden{display:none !important;}
    .hint{font-size:14px;color:#555;margin-top:8px;line-height:1.45;}
    .note{
      background:#f6fbff;border:1px solid #d6e8ff;border-radius:12px;padding:10px 12px;
      color:#234; font-size:14px; line-height:1.45;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>コンサルツール</h1>
      <p>プラン提案の分岐・比較表などを追加していきます。</p>

      <div class="divider"></div>

      <!-- 端末あり（機変/MNP端末あり）のとき-->
      <div id="payTypeBlock" class="hidden">
        <label>端末の購入方法（支払い）</label>
        <select id="payType">
          <option value="" selected>未選択</option>
          <option value="nojimaInstall" id="optNojimaInstall">分リセ</option>
          <option value="carrierInstall">キャリアの分割</option>
          <option value="lump">一括</option>
        </select>
      </div>

      <!-- SIMのみのとき -->
      <div id="simOnlyNote" class="hidden">
        <div class="note">
          SIMのみ（端末なし）のため、データ移行・下取り受付は基本発生しません。
        </div>
      </div>

      <div class="divider"></div>

      <!-- 端末ありのときだけ表示（SIMのみは弾く） -->
      <div id="dataTransferBlock">
        <label>データ移行の有無</label>
        <select id="needDataTransfer">
          <option value="yes">あり</option>
          <option value="no" selected>なし</option>
        </select>
      </div>

      <div style="margin-top:12px;" id="tradeInReceptionBlock">
        <label>下取り受付の有無</label>
        <select id="needTradeInReception">
          <option value="yes">あり</option>
          <option value="no" selected>なし</option>
        </select>
      </div>

      <div class="row">
        <button class="btn2" id="backToContractBtn">← 契約ナビに戻る</button>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = "contract_navi_ctx_v1";
const el = (id) => document.getElementById(id);

function readShared(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return {};
  try { return JSON.parse(raw) || {}; } catch(e){ return {}; }
}
function writeShared(patch){
  const cur = readShared();
  const next = { ...cur, ...patch };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
  return next;
}

/* 端末が関係する契約かどうか（= payType / データ移行 / 下取りの対象） */
function needsDeviceFlow(ct){
  return ct === "deviceChange" || ct === "mnpDevice";
}

(function init(){
  const shared = readShared();
  const ct = shared.contractType || "";
  const deviceFlow = needsDeviceFlow(ct);
  const isDeviceChange = (ct === "deviceChange");

  // payType：端末ありだけ表示
  if (el("payTypeBlock")) el("payTypeBlock").classList.toggle("hidden", !deviceFlow);

  // SIMのみ（端末なし）メモ
  if (el("simOnlyNote")) el("simOnlyNote").classList.toggle("hidden", deviceFlow);

  // データ移行 / 下取り：端末ありだけ表示
  if (el("dataTransferBlock")) el("dataTransferBlock").classList.toggle("hidden", !deviceFlow);
  if (el("tradeInReceptionBlock")) el("tradeInReceptionBlock").classList.toggle("hidden", !deviceFlow);

  // ★ 機種変更は「分リセ」を選べない（端末あり画面のときだけ）
  if (deviceFlow && isDeviceChange){
    const opt = el("optNojimaInstall");
    if (opt){
      opt.disabled = true;
      opt.textContent = "分リセ ※機種変更では選択不可";
    }

    // 既に分リセが入ってたら事故防止で解除
    if ((shared.payType || "") === "nojimaInstall"){
      if (el("payType")) el("payType").value = "";
      writeShared({ payType: "" });
    }
  }

  // 初期値復元
  if (deviceFlow){
    if (el("payType") && shared.payType) el("payType").value = shared.payType;

    if (el("needDataTransfer") && shared.needDataTransfer){
      el("needDataTransfer").value = shared.needDataTransfer;
    }
    if (el("needTradeInReception") && shared.needTradeInReception){
      el("needTradeInReception").value = shared.needTradeInReception;
    }
  } else {
    // SIMのみ（端末なし）は常に no に固定して storage も事故防止
    if (el("payType")) el("payType").value = "";
    if (el("needDataTransfer")) el("needDataTransfer").value = "no";
    if (el("needTradeInReception")) el("needTradeInReception").value = "no";

    writeShared({
      payType: "",
      needDataTransfer: "no",
      needTradeInReception: "no"
    });
  }
})();

if (el("payType")){
  el("payType").addEventListener("change", () => {
    const shared = readShared();
    const ct = shared.contractType || "";

    if (ct === "deviceChange" && el("payType").value === "nojimaInstall"){
      el("payType").value = "";
      writeShared({ payType: "" });
      return;
    }
    writeShared({ payType: el("payType").value });
  });
}
if (el("needDataTransfer")){
  el("needDataTransfer").addEventListener("change", () => {
    writeShared({ needDataTransfer: el("needDataTransfer").value });
  });
}
if (el("needTradeInReception")){
  el("needTradeInReception").addEventListener("change", () => {
    writeShared({ needTradeInReception: el("needTradeInReception").value });
  });
}

// 戻るボタン：押した瞬間に保存して戻る
if (el("backToContractBtn")){
  el("backToContractBtn").onclick = () => {
    const shared = readShared();
    const ct = shared.contractType || "";
    const deviceFlow = needsDeviceFlow(ct);

    if (deviceFlow){
      if (el("payType") && !el("payTypeBlock").classList.contains("hidden")){
        writeShared({ payType: el("payType").value });
      }
      if (el("needDataTransfer")) writeShared({ needDataTransfer: el("needDataTransfer").value });
      if (el("needTradeInReception")) writeShared({ needTradeInReception: el("needTradeInReception").value });
    } else {
      // SIMのみ（端末なし）は固定
      writeShared({
        payType: "",
        needDataTransfer: "no",
        needTradeInReception: "no"
      });
    }

    window.location.href = "ContractNavigator.html";
  };
}
</script>
</body>
</html>