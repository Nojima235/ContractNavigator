<!-- =========================
     ContractNavigator.html
     ========================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¥‘ç´„ãƒŠãƒ“</title>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      margin:0;
      color:#111;
      font-size:17px;
      background: transparent;
    }

    html::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;

      background:
        linear-gradient(rgba(246,247,249,0.60), rgba(246,247,249,0.60)),
        url("consaru.jpg") center/150% repeat,
        #f6f7f9;
    }
    :root{
      --header-h: 200px; /* â† ã¨ã‚Šã‚ãˆãšã€‚ã‚ºãƒ¬ãŸã‚‰ã“ã“ã ã‘å¾®èª¿æ•´ */
    }

    html, body{
      height:100%;
      overflow:hidden;      /* â† ãƒšãƒ¼ã‚¸æœ¬ä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
    }

    .wrap{
    height: calc(100vh - var(--header-h));
    overflow:auto;
    -webkit-overflow-scrolling: touch;

    max-width:960px;
    margin:0 auto;
    padding:12px 16px 40px;
    }

    .donebox{
      background:#f6fbff;
      border:1px solid #d6e8ff;
      border-radius:12px;
      padding:12px;
      margin-top:10px;
    }

    .donebox b{
      display:inline-block;
      margin-bottom:6px;
    }

    header{
      padding:16px 16px 8px;
      background:#fff;
      border-bottom:1px solid #e6e8eb;
      position:relative;
      top:0;
      z-index:10;
    }

    .helpBtn{
      position:absolute;
      top:26px;
      right:24px;

      width:26px;
      height:26px;
      border-radius:50%;

      border:1px solid #7f848a;
      background:#ffffff;
      color:#5e666e;

      font-size:15px;
      font-weight:900;
      line-height:1;
      cursor:pointer;

      box-shadow:0 1px 3px rgba(0,0,0,.15);
    }

    .helpBtn:active{
      transform:scale(0.96);
    }
    .btnDanger{
      border:1px solid #ffd2d2;
      background:#fff5f5;
      color:#b00020;
      border-radius:12px;
      padding:14px 16px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
    }
    .resetGroup button{
      opacity:0.85;
    }
    .resetGroup button:hover{
      opacity:1;
    }
    .title{font-size:24px;font-weight:800;}
    .sub{font-size:15px;color:#555;margin-top:4px;}
    .card{
      background:#fff;border:1px solid #e6e8eb;border-radius:14px;padding:14px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);margin-top:12px;
    }
    .legal{color:#b00020;font-weight:800;}
    .state{font-size:20px;font-weight:800;}
    .muted{color:#555;font-size:14px;line-height:1.5;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{border:0;background:#111;color:#fff;border-radius:12px;padding:14px 16px;font-size:16px;cursor:pointer;}
    .btn:disabled{opacity:.4;cursor:not-allowed;}
    .btn2{border:1px solid #d9dde3;background:#fff;color:#111;border-radius:12px;padding:14px 16px;font-size:16px;cursor:pointer;}
    .stepbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .step{padding:10px 14px;border-radius:12px;background:#f0f2f5;font-size:16px;cursor:pointer;user-select:none;}
    .step.current{background:#dfe8ff;border:1px solid #9db6ff;}
    .step.done{background:#e7f7ea;border:1px solid #9fe0aa;}
    .warn{background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:12px;margin-top:10px;font-size:15px;}
    .warn b,.next b{display:inline-block;margin-bottom:6px;}
    .next{background:#f7f7ff;border:1px solid #d8ddff;border-radius:12px;padding:12px;margin-top:10px;}
    .hidden{display:none !important;}

    label{font-size:16px;color:#333;}
    select{
      width:100%;padding:14px 12px;border-radius:10px;border:1px solid #d9dde3;
      font-size:17px;background:#fff;
    }
    .grid{display:grid;gap:10px;margin-top:10px;}
    @media (min-width: 760px){
      .grid{grid-template-columns: 1fr 1fr;}
    }
    .divider{height:1px;background:#eef0f3;margin:12px 0;}
    .badge{
      display:inline-block;font-size:17px;padding:8px 16px;border-radius:999px;
      background:#f0f2f5;border:1px solid #e0e4ea;color:#333;
    }
    .badge.done{
      background:#e7f7ea;
      border:1px solid #9fe0aa;
      color:#1b5e20;
      font-weight:800;
    }

    .finishWrap{
      position: relative;
      max-width: 300px;
      margin: 0 auto;
      padding: 14px;
      background: #67abec;
      border-radius: 14px;
      border: 1px solid #67abec;
    }

    .finishWrap img{
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
    }

    /* ç”»åƒä¸Šãƒ†ã‚­ã‚¹ãƒˆ */
    .finishText{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffffff;
      font-size: 40px;
      font-weight: 900;
      letter-spacing: 0.08em;
      text-shadow:
        0 2px 6px rgba(0,0,0,0.35),   /* ç™½æ–‡å­—ãŒæ½°ã‚Œãªã„ */
        0 0 10px rgba(0,0,0,0.25);
      pointer-events: none;          /* ã‚¯ãƒªãƒƒã‚¯é‚ªé­”ã—ãªã„ */
    }

    /* check list */
    .checklist{margin-top:10px;display:flex;flex-direction:column;gap:8px;}
    .checkitem{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid #e6e8eb;border-radius:12px;padding:10px 12px;background:#fff;
    }
    .checkitem input{margin-top:2px;transform:scale(1.2);}
    .checkitem .ctitle{font-size:15px;font-weight:700;}
    .checkitem .csub{font-size:14px;color:#555;margin-top:2px;line-height:1.35;}

    /* red warning */
    .alert{
      background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:10px 12px;margin-top:10px;
      color:#b00020;font-size:15px;font-weight:700;
    }
    .red{color:#b00020;font-size:15px;font-weight:800;}

    #navRow button{min-height:48px;}

    /* summary éè¡¨ç¤ºï¼ˆé‚ªé­”ï¼‰ */
    #summaryText { display:none !important; }
    #linebarMini .step{
      border-radius:999px;
      font-weight:700;
      padding:8px 14px;
    }

    /* ===== å›ç·šãƒãƒ¼å…±é€šï¼ˆä¸Šãƒ»ä¸‹ã§åŒä¸€ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ ===== */
    #linebar .step,
    #linebarMini .step{
      border-radius:999px;
      font-weight:700;
      padding:8px 14px;
    }

    /* ===== å›ç·š1ï¼šãƒ‘ãƒ¼ãƒ—ãƒ« ===== */
    #linebar .step:nth-child(1),
    #linebarMini .step:nth-child(1){
      background:#f3f1fb;
      border:1px solid #d9d3f2;
      color:#4a3f7a;
    }
    #linebar .step:nth-child(1).current,
    #linebarMini .step:nth-child(1).current{
      background:#e6defa;
      border:2px solid #7a5ce6;
      color:#2f1c6b;
    }

    /* ===== å›ç·š2ï¼šã‚ªãƒ¬ãƒ³ã‚¸ ===== */
    #linebar .step:nth-child(2),
    #linebarMini .step:nth-child(2){
      background:#fff3e6;
      border:1px solid #ffd7b5;
      color:#8a4b00;
    }
    #linebar .step:nth-child(2).current,
    #linebarMini .step:nth-child(2).current{
      background:#ffe1c2;
      border:2px solid #ff9800;
      color:#5a2f00;
    }

    /* ===== å›ç·š3ï¼šãƒ”ãƒ³ã‚¯ ===== */
    #linebar .step:nth-child(3),
    #linebarMini .step:nth-child(3){
      background:#fff0f6;
      border:1px solid #f5c2d8;
      color:#7a294e;
    }
    #linebar .step:nth-child(3).current,
    #linebarMini .step:nth-child(3).current{
      background:#ffd6e8;
      border:2px solid #e91e63;
      color:#4a102b;
    }

    /* ===== å›ç·š4ï¼šãƒ–ãƒ©ã‚¦ãƒ³ ===== */
    #linebar .step:nth-child(4),
    #linebarMini .step:nth-child(4){
      background:#f6efe9;
      border:1px solid #d8c7b7;
      color:#5c3b1e;
    }
    #linebar .step:nth-child(4).current,
    #linebarMini .step:nth-child(4).current{
      background:#eadfd5;
      border:2px solid #8d6e63;
      color:#3e2614;
    }

    /* ===== å›ç·š5ï¼šãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ ===== */
    #linebar .step:nth-child(5),
    #linebarMini .step:nth-child(5){
      background:#f1f1f1;
      border:1px solid #cfcfcf;
      color:#333;
    }
    #linebar .step:nth-child(5).current,
    #linebarMini .step:nth-child(5).current{
      background:#e0e0e0;
      border:2px solid #555;
      color:#111;
    }

    /* ===== ç¾åœ¨é¸æŠã®è¦–è¦šè£œåŠ©ï¼ˆè‰²è¦šå¯¾ç­–ï¼‰ ===== */
    #linebar .step.current::before,
    #linebarMini .step.current::before{
      content:"â–¶";
      margin-right:6px;
    }
  </style>
</head>
<body>
<header>
  <div class="title">å¥‘ç´„ãƒŠãƒ“</div>
  <div class="sub">ã€Œä»Šã©ã“ï¼Ÿ æ³¨æ„ç‚¹ã¯ï¼Ÿ æ¬¡ã¯ä½•ï¼Ÿã€å¥‘ç´„ã®ãƒ•ãƒ­ãƒ¼ã‚’1ç”»é¢ã§ç¢ºèª</div>
  <button id="helpBtn" class="helpBtn">i</button>
</header>

<div class="wrap">
  <!-- å…¥å£ï¼šæ¡ä»¶é¸æŠï¼ˆåˆ†å²ã®å…ƒï¼‰ -->
   <div class="card" style="margin-top:12px;">
  <div class="state">ğŸ“±å›ç·š</div>
  <div class="row" style="gap:8px; align-items:center;">
    <div class="stepbar" id="linebar" style="margin-top:0;"></div>
    <button class="btn2" id="addLineBtn">ï¼‹å›ç·šè¿½åŠ </button>
    <button class="btn2" id="removeLineBtn">ï¼å‰Šé™¤</button>
  </div>
</div>
  <div class="card">
    <div class="state">ğŸ“‹ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆ</div>

    <div class="divider"></div>

    <div class="row" style="gap:8px;">
      <span class="badge" id="badge_basic">åŸºæœ¬æ¡ä»¶</span>
    </div>

    <div class="grid">
      <div>
        <label>å¥‘ç´„ã‚¿ã‚¤ãƒ—</label>
        <select id="contractType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="mnpDevice">MNPï¼ˆç«¯æœ«ã‚ã‚Šï¼‰</option>
          <option value="mnpSim">MNPï¼ˆSIMã®ã¿ï¼‰</option>
          <option value="deviceChange">æ©Ÿç¨®å¤‰æ›´</option>
        </select>
      </div>

      <div>
        <label>å¥‘ç´„è€…æ§˜ï¼ˆåç¾©ï¼‰</label>
        <select id="contractHolder">
          <option value="self" selected>ã”æœ¬äºº</option>
          <option value="spouse">é…å¶è€…</option>
          <option value="child">ãŠå­æ§˜</option>
          <option value="parent">ã”ä¸¡è¦ª</option>
          <option value="other">ãã®ä»–</option>
        </select>
      </div>

      <div>
        <label>æœ¬äººç¢ºèªæ›¸é¡</label>
        <select id="idType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="license">é‹è»¢å…è¨±è¨¼</option>
          <option value="myNumber">ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰</option>
        </select>
      </div>

      <div>
        <label>ã”åˆ©ç”¨è€…æ§˜</label>
        <div style="margin:8px 0 6px;">
          <label style="display:flex; gap:10px; align-items:center; user-select:none;">
            <input type="checkbox" id="useDifferentUser" />
            <span>å¥‘ç´„è€…æ§˜ã¨ã”åˆ©ç”¨è€…æ§˜ãŒç•°ãªã‚‹</span>
          </label>
        </div>

        <select id="userRelation" disabled>
          <option value="spouse">é…å¶è€…</option>
          <option value="child">ãŠå­æ§˜</option>
          <option value="parent">ã”ä¸¡è¦ª</option>
          <option value="other">ãã®ä»–</option>
        </select>
      </div>
        </div>

    <div class="divider"></div>

    <div class="row" style="gap:8px;">
      <span class="badge" id="badge_credit">ä¸ä¿¡æ™‚ç‚¹ã®ç¢ºèª</span>
    </div>

    <div class="grid">
      <div>
        <label>ç¾åœ¨ãŠä½¿ã„ã®ã‚­ãƒ£ãƒªã‚¢</label>
        <select id="carrier">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="docomo">docomo</option>
          <option value="ahamo">ahamo</option>
          <option value="au">au</option>
          <option value="uq">UQ mobile</option>
          <option value="softbank">SoftBank</option>
          <option value="ymobile">Y!mobile</option>
          <option value="other">ãã®ä»–</option>
          <option value="new">æ–°è¦</option>
        </select>
      </div>

      <div>
        <label>ã”è‡ªå®…ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå›ç·š</label>
        <select id="homeNetType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="fletshikari">ãƒ•ãƒ¬ãƒƒãƒ„å…‰</option>
          <option value="nurohikari">NUROå…‰</option>
          <option value="docomohikari">ãƒ‰ã‚³ãƒ¢å…‰</option>
          <option value="niftyhikari">@niftyå…‰</option>
          <option value="softbankhikari">ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯å…‰</option>
          <option value="auhikari">auã²ã‹ã‚Š</option>
          <option value="jcom">J:COM</option>
          <option value="home5g">ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ã‚¿ãƒ¼</option>
          <option value="unknown">ãã®ä»–</option>
          <option value="none">ã”åˆ©ç”¨ãªã—</option>
        </select>
      </div>

      <div>
        <label>æœˆã®ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ï¼ˆç›®å®‰ï¼‰</label>
        <select id="dataUsage">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="lte5">ã€œ5GB</option>
          <option value="lte30">ã€œ30GB</option>
          <option value="unlimited">30GBä»¥ä¸Šï¼ˆç„¡åˆ¶é™ï¼‰</option>
        </select>
      </div>

      <div>
        <label>ä½å±…å½¢æ…‹</label>
        <select id="housingType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="mansion">é›†åˆä½å®…ï¼ˆãƒãƒ³ã‚·ãƒ§ãƒ³ãƒ»ã‚¢ãƒ‘ãƒ¼ãƒˆï¼‰</option>
          <option value="house">æˆ¸å»ºã¦</option>
        </select>
      </div>

      <div>
        <label>åˆ©ç”¨å¹´æ•°ï¼ˆã‚¹ãƒãƒ›ã‚­ãƒ£ãƒªã‚¢ï¼‰</label>
        <select id="usageYears">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="lt6m">âš åŠå¹´æœªæº€âš </option>
          <option value="gt6m">åŠå¹´ä»¥ä¸Š</option>
        </select>
      </div>

      <div>
        <label>åˆ©ç”¨å¹´æ•°ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå›ç·šï¼‰</label>
        <select id="homeNetYears">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="lt12m">âš 1å¹´æœªæº€âš </option>
          <option value="gt12m">1å¹´ä»¥ä¸Š</option>
        </select>
      </div>
    </div>

    <!-- ãƒã‚§ãƒƒã‚¯ï¼ˆé–‹å§‹å‰ï¼‰ -->
    <div class="divider"></div>
    <div class="row" style="gap:8px;">
      <span class="badge" id="badge_check">ç¢ºèªãƒã‚§ãƒƒã‚¯</span>
    </div>

    <div class="checklist">
      <div class="checkitem">
        <input type="checkbox" id="chk_id_confirmed" />
        <div>
          <div class="ctitle">æœ¬äººç¢ºèªæ›¸é¡ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
          <div class="csub">æ°åï¼ç”Ÿå¹´æœˆæ—¥ï¼ä½æ‰€ãªã©</div>
        </div>
      </div>

      <div class="checkitem">
        <input type="checkbox" id="chk_homeNet_asked" />
        <div>
          <div class="ctitle">ã‚­ãƒ£ãƒªã‚¢ãŠã‚ˆã³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå›ç·šã®åˆ©ç”¨å¹´æ•°ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
          <div class="csub">ã€ŒåŠå¹´ä»¥ä¸ŠãŠä½¿ã„ã§ã™ã‹ï¼Ÿã€ãªã©ã€ãƒ’ã‚¢ãƒªãƒ³ã‚°æ¸ˆã¿</div>
        </div>
      </div>
    </div>

    <!-- ç«¯æœ«ã‚ã‚Šã®ã¨ãã ã‘ï¼šä¸‹å–ã‚Šç¢ºèª -->
    <div class="checklist hidden" id="tradeinBlock">
      <div class="checkitem">
        <input type="checkbox" id="chk_tradein" />
        <div style="flex:1;">
          <div class="ctitle">ç«¯æœ«ä¸‹å–ã‚Šã®å¯å¦ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
          <div class="csub">åˆ†å‰²ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã”åˆ©ç”¨ã®å ´åˆã€ç«¯æœ«ã®æ®‹å‚µã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
        </div>

        <!-- â˜…è¿½åŠ ï¼šä¸‹å–ã‚Š OK/NG -->
        <select id="tradeinResult" style="width:140px; padding:10px 10px; border-radius:10px;">
          <option value="" selected>æœªé¸æŠ</option>
          <option value="ok">ä¸‹å–ã‚ŠOK</option>
          <option value="ng">ä¸‹å–ã‚ŠNG</option>
        </select>
      </div>
    </div>

    <!-- å³æ™‚è­¦å‘Šï¼ˆé–‹å§‹å‰ï¼‰ -->
    <div class="alert hidden" id="preAlert"></div>

    <div class="row" style="margin-top:12px; align-items:center; width:100%;">
  <!-- å·¦ï¼šé–‹å§‹ -->
  <div class="row" style="gap:10px;">
    <button class="btn" id="startBtn" disabled>ã“ã®æ¡ä»¶ã§é–‹å§‹</button>
  </div>

  <!-- å³ã«æŠ¼ã—å‡ºã™ã‚¹ãƒšãƒ¼ã‚µ -->
  <div style="flex:1;"></div>

  <!-- å³ï¼šãƒªã‚»ãƒƒãƒˆç³» -->
  <div class="row resetGroup" style="gap:10px;">
    <button class="btn2" id="resetBtn">ã“ã®å›ç·šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btnDanger" id="wipeAllBtn">å…¨ã¦ã®å›ç·šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒ¼ -->
  <div class="card">
    <div class="state">ğŸ“ç¾åœ¨åœ°</div>
       <div class="row" style="gap:8px; align-items:center; margin-top:8px;">
      <div class="stepbar" id="linebarMini" style="margin-top:0;"></div>
    </div>
    <div class="stepbar" id="stepbar"></div>
    <div class="muted" id="summaryText">æ¡ä»¶ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„</div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—å†…å®¹ -->
  <div class="card" id="stepCard">
    <div class="state" id="stepTitle">é–‹å§‹ã—ã¦ãã ã•ã„</div>

    <div class="warn hidden" id="warnBox">
      <b>âš  ã“ã“ã§ã®æ³¨æ„</b>
      <ul id="warnList" style="margin:0 0 0 18px;"></ul>
    </div>

    <div class="next hidden" id="nextBox">
      <b>ğŸ‘‰ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</b>
      <div id="nextAction" style="margin-top:6px;"></div>
    </div>

<!-- S3: MNP(SIMã®ã¿ï¼‰å¥‘ç´„ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="s3SimChecklist">
  <div class="checklist" style="margin-top:8px;">

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_mnp" />
      <div>
        <div class="ctitle">MNPäºˆç´„ç•ªå·ã®å–å¾—</div>
        <div class="csub">å–å¾—æ¸ˆã¿ãªã‚‰OKã€€è¤‡é›‘ãªå ´åˆã¯é›»è©±ã§</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_docs" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®ãŠé ã‹ã‚Š</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ã®ãŸã‚</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_input" />
      <div>
        <div class="ctitle">å¥‘ç´„æƒ…å ±ã‚’å…¥åŠ›</div>
        <div class="csub">æ°åã‚„ç”Ÿå¹´æœˆæ—¥ãªã©ã®å…¥åŠ›ãƒŸã‚¹ã«æ³¨æ„</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_notice" />
      <div>
        <div class="ctitle">é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã®ã”æ¡ˆå†…</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ä¸­ã«ã”è¦§ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚º</div>
      </div>
    </div>

  </div>
</div>

<!-- S3N: åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="s3nChecklist">
  <div class="checklist" style="margin-top:8px;">
    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_mnp" />
      <div>
        <div class="ctitle">MNPäºˆç´„ç•ªå·ã®å–å¾—</div>
        <div class="csub">å–å¾—æ¸ˆã¿ãªã‚‰OKã€€è¤‡é›‘ãªå ´åˆã¯é›»è©±ã§</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_prepare" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®ãŠé ã‹ã‚Š</div>
        <div class="csub">åˆ†ãƒªã‚»ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã®ã¿å¯ï¼ˆå¾Œæ—¥ç™»éŒ²å¯ï¼‰</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_apply" />
      <div>
        <div class="ctitle">åˆ†ãƒªã‚»ã®ç”³è«‹</div>
        <div class="csub">ãƒ¢ãƒã‚¤ãƒ« â†’ å†…å®¹ç¢ºèª â†’ åˆ†ãƒªã‚»ç”¨QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_input" />
      <div>
        <div class="ctitle">å¥‘ç´„æƒ…å ±ã‚’å…¥åŠ›</div>
        <div class="csub">æ°åã‚„ç”Ÿå¹´æœˆæ—¥ãªã©ã®å…¥åŠ›ãƒŸã‚¹ã«æ³¨æ„ã€€<span class="legal">å¯©æŸ»çµæœãŒå‡ºã‚‹ã¾ã§ã¯ç¢ºå®šã—ãªã„</span></div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_video" />
      <div>
        <div class="ctitle">é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã®ã”æ¡ˆå†…</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ä¸­ã«ã”è¦§ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚º</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_result" />
      <div>
        <div class="ctitle">å¯©æŸ»çµæœã‚’ç¢ºèª</div>
        <div class="csub">OKãªã‚‰å¥‘ç´„ç¢ºå®šã¸ï¼NGãªã‚‰ä»£æ›¿æ¡ˆã¸</div>
      </div>
    </div>
  </div>
</div>

    <!-- å¥‘ç´„å¾Œå¯¾å¿œã€€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="doneChecklist">
  <div class="checklist" style="margin-top:8px;">
    <div class="checkitem">
      <input type="checkbox" id="chk_done_return" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®è¿”å´</div>
        <div class="csub">å…è¨±è¨¼ï¼ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ï¼ã‚¯ãƒ¬ã‚«ç­‰ã®è¿”ã—å¿˜ã‚Œé˜²æ­¢</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_open" />
      <div>
        <div class="ctitle">é–‹é€šç¢ºèª</div>
        <div class="csub">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡ï¼ç™ºç€ä¿¡</div>
      </div>
    </div>
    <div class="checkitem hidden" id="doneDataTransferItem">
      <input type="checkbox" id="chk_done_datatransfer" />
      <div>
        <div class="ctitle">ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</div>
        <div class="csub">æ–°ã—ã„ç«¯æœ«ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ä¸å…·åˆé˜²æ­¢</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_point" />
      <div>
        <div class="ctitle">POSã§ã®ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãŠã‚ˆã³ãŠä¼šè¨ˆ</div>
        <div class="csub">ãƒ¢ãƒã‚¤ãƒ«QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æ™‚é–“ã‚„èª¤ç´ã¥ã‘ã«æ³¨æ„</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_consent" />
      <div>
        <div class="ctitle">ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒåŒæ„æ›¸ã®è¨˜å…¥</div>
        <div class="csub">ç¢ºèªäº‹é …ã®ãƒã‚§ãƒƒã‚¯ã¨ç½²å</div>
      </div>
    </div>
    <div class="checkitem hidden" id="doneTradeInItem">
      <input type="checkbox" id="chk_done_tradein" />
      <div>
        <div class="ctitle">å¤ç‰©ä¸‹å–ã‚Šå—ä»˜</div>
        <div class="csub">å½“æ—¥å—ä»˜ï¼å¾Œæ—¥å—ä»˜ã¯2é€±é–“ä»¥å†…</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_car" />
      <div>
        <div class="ctitle">ãŠè»Šã®ã”åˆ©ç”¨ã‚’ç¢ºèª</div>
        <div class="csub">2æ™‚é–“é§è»Šåˆ¸ã®ãŠæ¸¡ã—ã€€è¶…éæ™‚ã¯ãƒãƒ«ã‚¨ãƒ„ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¸èª˜å°</div>
      </div>
    </div>
  </div>
</div>

<div class="donebox hidden" id="multiFinishBox" style="text-align:center;">
  <div class="state" style="margin-bottom:6px;">âœ…ã“ã®å›ç·šã¯å®Œäº†</div>
  <div class="muted" id="multiFinishText" style="font-size:16px;">
    æ¬¡ã®å›ç·šã®å¥‘ç´„ã‚’é€²ã‚ã¦ãã ã•ã„
  </div>
  <div class="row" style="justify-content:center; margin-top:12px;">
    <button class="btn" id="gotoNextLineBtn">æ¬¡ã®å›ç·šã¸ â†’</button>
  </div>
</div>

<!-- å®Œäº†ç”»é¢ï¼ˆS5ã®ã¿è¡¨ç¤ºï¼‰ -->
<div class="donebox hidden" id="finishBox" style="text-align:center;">
  <div class="finishWrap">
    <div class="finishText">Completed!</div>
    <img
      src="otsukare.png"
      alt="ãŠç–²ã‚Œã•ã¾ã§ã—ãŸ"
      onerror="this.style.display='none'; document.getElementById('finishFallback').classList.remove('hidden');"
    />
  </div>
</div>

    <div class="row" id="navRow" style="margin-top:12px; align-items:center; width:100%;">
      <div class="row" style="gap:10px;">
        <button class="btn2" id="backBtn">â† æˆ»ã‚‹</button>
        <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      </div>

      <div style="flex:1;"></div>

      <button class="btn2 hidden" id="openConsultBtn">ã‚³ãƒ³ã‚µãƒ«ãƒ„ãƒ¼ãƒ« â†—</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Utils
   ========================= */
const el = (id) => document.getElementById(id);

function needsDeviceFlow(ct){
  return ct === "deviceChange" || ct === "mnpDevice";
}
function isMnp(ct){
  return ct === "mnpDevice" || ct === "mnpSim";
}

/* =========================
   Storage (Multi line)
   ========================= */
const STORAGE_KEY = "contract_navi_ctx_v2_multi";

function blankLine(){
  return {
    form: {
      contractType:"", contractHolder:"self",
      useDifferentUser:false, userRelation:"self",
      idType:"",
      carrier:"", housingType:"", dataUsage:"", usageYears:"",
      chk_id_confirmed:false, chk_homeNet_asked:false,
      chk_tradein:false, tradeinResult:""
    },
    consult: { payType:"", needDataTransfer:"no", needTradeInReception:"no" },
    flow:   { started:false, stepId:"S1" },
    s3:     { chk_s3sim_mnp:false, chk_s3sim_docs:false, chk_s3sim_input:false, chk_s3sim_notice:false },
    s3n:    { chk_s3n_mnp:false, chk_s3n_apply:false, chk_s3n_prepare:false, chk_s3n_input:false, chk_s3n_video:false, chk_s3n_result:false },
    s4:     { chk_done_return:false, chk_done_open:false, chk_done_datatransfer:false, chk_done_point:false, chk_done_consent:false, chk_done_tradein:false, chk_done_car:false }
  };
}

function readSharedSafe(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return { activeLine: 0, lines: [] };
  try {
    const obj = JSON.parse(raw) || {};
    obj.activeLine = Number.isInteger(obj.activeLine) ? obj.activeLine : 0;
    obj.lines = Array.isArray(obj.lines) ? obj.lines : [];
    return obj;
  } catch(e){
    return { activeLine: 0, lines: [] };
  }
}

function ensureLines(){
  const shared = readSharedSafe();
  if (shared.lines.length === 0){
    shared.lines.push(blankLine());
    shared.activeLine = 0;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  }
    // â˜…ä¸–å¸¯å…±é€šã®è‡ªå®…å›ç·šï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
  if (!shared.houseNet){
    shared.houseNet = { homeNetType:"", homeNetYears:"", housingType:""};
  } else {
  if (shared.houseNet.housingType == null) shared.houseNet.housingType = "";
}

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  return shared;
}

let activeLine = 0;

function setActiveLine(i){
  const shared = ensureLines();
  const clamped = Math.max(0, Math.min(i, shared.lines.length - 1));
  shared.activeLine = clamped;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  activeLine = clamped;
}

/* =========================
   Labels
   ========================= */
function labelCarrier(v){
  return ({
    docomo:"docomo", ahamo:"ahamo", au:"au", uq:"UQ mobile",
    softbank:"SoftBank", ymobile:"Y!mobile", other:"ãã®ä»–",
    new:"æ–°è¦"
  })[v] || v;
}
function labelUsageYears(v){
  return ({ lt6m:"åŠå¹´æœªæº€", "gt6m":"åŠå¹´ä»¥ä¸Š"})[v] || v;
}
function labelDataUsage(v){
  return ({ lte5:"ã€œ5GB", lte30:"ã€œ30GB", unlimited:"30GBä»¥ä¸Šï¼ˆç„¡åˆ¶é™ï¼‰" })[v] || v;
}
function labelHousingType(v){
  return ({ mansion:"ãƒãƒ³ã‚·ãƒ§ãƒ³", house:"æˆ¸å»ºã¦", unknown:"ä¸æ˜" })[v] || v;
}
function labelIdType(v){
  return ({ license:"é‹è»¢å…è¨±è¨¼", myNumber:"ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰", student:"å­¦ç”Ÿè¨¼"})[v] || v;
}
function labelUserRelation(v){
  return ({ self:"ã”æœ¬äºº", spouse:"é…å¶è€…", child:"ãŠå­æ§˜", parent:"ã”ä¸¡è¦ª", other:"ãã®ä»–" })[v] || v;
}
function labelHomeNetType(v){
  return ({
    docomohikari:"ãƒ‰ã‚³ãƒ¢å…‰", niftyhikari:"@niftyå…‰", softbankhikari:"ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯å…‰",
    otherntthikari:"ãã®ä»–ã‚³ãƒ©ãƒœå…‰", auhikari:"auã²ã‹ã‚Š", jcom:"J:COM",
    nurohikari:"NUROå…‰", fletshikari:"ãƒ•ãƒ¬ãƒƒãƒ„å…‰", home5g:"ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ã‚¿",
    mobile:"ãƒ¢ãƒã‚¤ãƒ«ãƒ«ãƒ¼ã‚¿", none:"ãªã—", unknown:"ä¸æ˜"
  })[v] || v;
}
function labelHomeNetYears(v){
  return ({ lt12m:"1å¹´æœªæº€", gt12m:"1å¹´ä»¥ä¸Š"})[v] || v;
}
function labelPayType(v){
  return ({
    nojimaInstall:"ãƒã‚¸ãƒåˆ†å‰²",
    carrierInstall:"ã‚­ãƒ£ãƒªã‚¢åˆ†å‰²",
    lump:"ä¸€æ‹¬"
  })[v] || v;
}

/* =========================
   State
   ========================= */
let ctx = null;
let steps = [];
let idx = -1;

/* =========================
   Steps
   ========================= */
function buildSteps(contractType, payType) {
  const s = [];
  s.push({ id: "S1", name: "1. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆä¸ä¿¡ï¼‰" });
  s.push({ id: "S2", name: "2. ãƒ—ãƒ©ãƒ³ã®ã‚³ãƒ³ã‚µãƒ«" });

  if (!needsDeviceFlow(contractType)) {
    s.push({ id: "S3", name: "3. å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  if (!payType) return s;

  if (payType === "nojimaInstall") {
    s.push({ id: "S3N", name: "3. åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  if (payType === "carrierInstall") {
    s.push({ id: "S3C", name: "3. åˆ†å‰²å¯©æŸ»ãƒ»å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  s.push({ id: "S3", name: "3. å¥‘ç´„" });
  s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
  s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
  return s;
}

/* =========================
   Business logic
   ========================= */
function isUpgradeBlocked(tmp){
  const mobileShort = (tmp.usageYears === "lt6m");
  const homeShort   = (tmp.homeNetYears === "lt12m");
  return { blocked: (mobileShort || homeShort), mobileShort, homeShort };
}

/* =========================
   UI: badges / preAlert
   ========================= */
function updateTradeInVisibility(){
  const ct = el("contractType").value;
  const block = el("tradeinBlock");
  if (needsDeviceFlow(ct)){
    block.classList.remove("hidden");
  } else {
    el("chk_tradein").checked = false;
    if (el("tradeinResult")) el("tradeinResult").value = "";
    block.classList.add("hidden");
  }
  updateBadges();
}
function sectionDone(ids){
  return ids.every(id => {
    const node = el(id);
    if (!node) return false;
    if (node.type === "checkbox") return node.checked;
    return (node.value || "").trim() !== "";
  });
}

function setDone(id, ok){
  const b = el(id);
  if (!b) return;
  b.classList.toggle("done", ok);
}

function updateBadges(){
  const basicOk  = sectionDone(["contractType","contractHolder","idType"]);
  const creditOk = sectionDone(["carrier","usageYears","dataUsage","housingType","homeNetType","homeNetYears"]);
  setDone("badge_basic",  basicOk);
  setDone("badge_credit", creditOk);

  const ct = el("contractType").value;
  const baseChecksOk = sectionDone(["chk_id_confirmed","chk_homeNet_asked"]);
  const tradeOk = needsDeviceFlow(ct)
    ? (el("chk_tradein").checked && (el("tradeinResult") ? (el("tradeinResult").value || "").trim() !== "" : false))
    : true;

  setDone("badge_check", baseChecksOk && tradeOk);
}

function updatePreAlert(){
  const box = el("preAlert");
  const ready = ["usageYears","homeNetYears"].every(id => (el(id).value || "").trim() !== "");
  if (!ready){
    box.classList.add("hidden");
    box.textContent = "";
    return;
  }
  const tmp = { usageYears: el("usageYears").value, homeNetYears: el("homeNetYears").value };
  const r = isUpgradeBlocked(tmp);
  if (r.blocked){
    const parts = [];
    if (r.mobileShort) parts.push("ã‚¹ãƒãƒ›ã‚­ãƒ£ãƒªã‚¢åˆ©ç”¨ãŒåŠå¹´æœªæº€");
    if (r.homeShort) parts.push("è‡ªå®…å›ç·šåˆ©ç”¨ãŒ1å¹´æœªæº€");
    box.textContent = `ã€è­¦å‘Šã€‘${parts.join(" ã¾ãŸã¯ ")}ã®ãŸã‚ã€å½“åº—ã§ã®ãŠä¹—ã‚Šæ›ãˆã¯ä¸å¯ã¨ãªã‚Šã¾ã™`;
    box.classList.remove("hidden");
  } else {
    box.classList.add("hidden");
    box.textContent = "";
  }
}

function allSelected(){
  const requiredSelects = [
  "contractType","contractHolder","idType",
  "carrier","usageYears","dataUsage","housingType"
];

if (activeLine === 0){
    requiredSelects.push("homeNetType","homeNetYears");
  }
  const okSel = requiredSelects.every(id => (el(id).value || "").trim() !== "");
  if (!okSel) return false;

  if (!el("chk_id_confirmed").checked) return false;
  if (!el("chk_homeNet_asked").checked) return false;

  const ct = el("contractType").value;
  if (needsDeviceFlow(ct)){
    if (!el("chk_tradein").checked) return false;
    if (!el("tradeinResult") || (el("tradeinResult").value || "").trim() === "") return false;
  }
  return true;
}

function syncUserRelationLock(){
  const diff = el("useDifferentUser").checked;

  // åˆ©ç”¨è€… select ã®ON/OFF
  el("userRelation").disabled = !diff;

  if (!diff){
    // åŒä¸€æƒ³å®šï¼šå¿…ãšæœ¬äººã«å›ºå®š
    el("userRelation").value = "self";
  }
}

function updateStartEnabled(){
  el("startBtn").disabled = !allSelected();
  updatePreAlert();
  updateBadges();
}

/* =========================
   Step content
   ========================= */
function contentFor(stepId, ctx){
  const warn = [];
  let next = "";

  if (stepId === "S1"){
    const r = isUpgradeBlocked(ctx);
    if (r.blocked){
      const parts = [];
      if (r.mobileShort) parts.push("ã‚¹ãƒãƒ›ã‚­ãƒ£ãƒªã‚¢åˆ©ç”¨ãŒåŠå¹´æœªæº€");
      if (r.homeShort) parts.push("è‡ªå®…å›ç·šåˆ©ç”¨ãŒ1å¹´æœªæº€");
      warn.push(`ã€è­¦å‘Šã€‘${parts.join(" ã¾ãŸã¯ ")}ã®ãŸã‚ã€å½“åº—ã§ã®ãŠä¹—ã‚Šæ›ãˆã¯ä¸å¯ã¨ãªã‚Šã¾ã™`);
    }
    warn.push("ä¸ä¿¡ã«ã¯ã”æœ¬äººç¢ºèªæ›¸é¡ãŒå¿…è¦ã§ã™");
    if(needsDeviceFlow(ctx.contractType)) warn.push("åˆ†å‰²ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã”åˆ©ç”¨ã®å ´åˆã€ç«¯æœ«ã®æ®‹å‚µã‚’ç¢ºèª");

    if (ctx.userRelation !== "self") warn.push("ã”åˆ©ç”¨è€…æ§˜ãŒã”æœ¬äººä»¥å¤–ï¼šå¥‘ç´„åç¾©ãƒ»åŒæ„/ç¢ºèªäº‹é …ã®æ•´ç†ãŒå¿…è¦ã§ã™");
    if (ctx.homeNetType === "none") warn.push("è‡ªå®…å›ç·šãªã—ï¼šå¿…è¦ãªã‚‰å›ç·šææ¡ˆã®æœ‰ç„¡ã‚’ç¢ºèª");

    next = "ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’ã‚‚ã¨ã«ãƒ—ãƒ©ãƒ³ã®ã‚³ãƒ³ã‚µãƒ«ã‚’è¡Œã†";
  }

  if (stepId === "S2"){
    warn.push("æ–½ç­–ã®é©ç”¨æ¡ä»¶ã‚„å¿…é ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ç­‰ã‚’æ˜ç¢ºã«ã”èª¬æ˜ã™ã‚‹");

    if (ctx.dataUsage === "lte5") warn.push("ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ãŒå°‘ãªã‚æƒ³å®šï¼ˆï½5GBï¼‰");
    if (ctx.dataUsage === "lte30") warn.push("ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ãŒä¸­ç¨‹åº¦æƒ³å®š(ï½30GBï¼‰");
    if (ctx.dataUsage === "unlimited") warn.push("ç„¡åˆ¶é™ãƒ—ãƒ©ãƒ³æƒ³å®š");
    if (ctx.carrier === "uq" && (ctx.usageYears === "gt6m")){
      warn.push("UQ mobile ã‚’6ã‹æœˆä»¥ä¸Šåˆ©ç”¨ï¼šauã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰²å¼•ã®å¯¾è±¡ç¢ºèª");
    }
    if (ctx.carrier === "ymobile" && (ctx.usageYears === "gt6m")){
      warn.push("Y!mobile ã‚’6ã‹æœˆä»¥ä¸Šåˆ©ç”¨ï¼šSoftBankã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰²å¼•ã®å¯¾è±¡ç¢ºèª");
    }

    if (needsDeviceFlow(ctx.contractType) && !ctx.payType){
      next = "ã‚³ãƒ³ã‚µãƒ«ãƒ„ãƒ¼ãƒ«ã§è³¼å…¥æ–¹æ³•ã‚’é¸æŠã™ã‚‹";
    } else if (!needsDeviceFlow(ctx.contractType)){
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€å¥‘ç´„ã¸é€²ã‚€";
    } else if (ctx.payType === "nojimaInstall"){
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„ã¸é€²ã‚€";
    } else {
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€å¥‘ç´„ã¸é€²ã‚€";
    }
  }

  if (stepId === "S3"){
    warn.push("ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã™ã‚‹");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¥‘ç´„ã‚’å®Œäº†ã—ã€å¥‘ç´„å¾Œå¯¾å¿œã«é€²ã‚€";
  }

  if (stepId === "S3N"){
    warn.push("ãŠå®¢æ§˜ã®ãƒ¢ãƒã‚¤ãƒ«QRã‚³ãƒ¼ãƒ‰ã‚’ã„ãŸã ãã€åˆ†å‰²ã®ç”³è«‹ã‚’è¡Œã†");
    warn.push("å¯©æŸ»ã¨ä¸¦è¡Œã—ã¦å¥‘ç´„å…¥åŠ›ã‚’è¡Œã†ãŒã€å¯©æŸ»çµæœãŒå‡ºã‚‹ã¾ã§ã¯ç™»éŒ²ã‚’ç¢ºå®šã—ãªã„");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¯©æŸ»çµæœã‚’ç¢ºèªå¾Œã€å¥‘ç´„ã‚’å®Œäº†ã™ã‚‹";
  }

  if (stepId === "S3C"){
    warn.push("å¯©æŸ»çµæœã«ã‚ˆã‚Šã€åˆ†å‰²ä¸å¯â†’ä¸€æ‹¬ã®ã¿ã¨ãªã‚‹å¯èƒ½æ€§ã‚‚");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¯©æŸ»çµæœã‚’ç¢ºèªå¾Œã€å¥‘ç´„ã‚’å®Œäº†ã™ã‚‹";
  }

  if (stepId === "S4"){
    if (needsDeviceFlow(ctx.contractType)
      && (ctx.payType === "carrierInstall" || ctx.payType === "lump")
      && (ctx.needTradeInReception === "no")){
      warn.push("ã€æ³¨æ„ã€‘è³¼å…¥æ–¹æ³•ãŒã€Œã‚­ãƒ£ãƒªã‚¢åˆ†å‰²ï¼ä¸€æ‹¬ã€ã‹ã¤ã€Œä¸‹å–ã‚Šãªã—ã€ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãŒã§ãã¾ã›ã‚“ï¼ˆä¸‹å–ã‚Šå—ä»˜ã®æœ‰ç„¡ã‚’å†ç¢ºèªï¼‰");
    }
    warn.push("ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰é¡ã‚’ç¢ºå®Ÿã«ãŠè¿”ã—ã™ã‚‹");
    warn.push("ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒåŒæ„æ›¸ã«ã”ç½²åã„ãŸã ã");
    next = "é–‹é€šç¢ºèªã‚„ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’è¡Œã†";
  }

  return { warn, next };
}

/* =========================
   Checklist gates
   ========================= */
function requiredDoneIds(curCtx){
  const ids = ["chk_done_return","chk_done_open","chk_done_point","chk_done_consent"];
  const deviceFlow = needsDeviceFlow(curCtx.contractType);
  if (deviceFlow && curCtx.needDataTransfer === "yes") ids.push("chk_done_datatransfer");
  if (deviceFlow && curCtx.needTradeInReception === "yes") ids.push("chk_done_tradein");
  const shared = ensureLines();
  const isLastLine = (activeLine === shared.lines.length - 1);
  if (isLastLine) ids.push("chk_done_car");
  return ids;
}
function isS3SimChecklistComplete(curCtx){
  const ids = ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"];
  return ids.every(id => el(id) && el(id).checked);
}
function isS3NChecklistComplete(curCtx){
  const ids = ["chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"];
  if (isMnp(curCtx.contractType)) ids.unshift("chk_s3n_mnp");
  return ids.every(id => el(id) && el(id).checked);
}
function isDoneChecklistComplete(curCtx){
  const ids = requiredDoneIds(curCtx);
  return ids.every(id => el(id) && el(id).checked);
}

/* =========================
   Render
   ========================= */
function render(){
  if (el("finishBox")) el("finishBox").classList.add("hidden");
  if (el("multiFinishBox")) el("multiFinishBox").classList.add("hidden");
  const bar = el("stepbar");
  bar.innerHTML = "";

  if (idx < 0){
    el("stepTitle").textContent = "é–‹å§‹ã—ã¦ãã ã•ã„";
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
    el("backBtn").disabled = true;
    el("nextBtn").disabled = true;
    el("openConsultBtn").classList.add("hidden");
    return;
  }

  const STEPBAR_VISIBLE_IDS = ["S1","S2","S3","S3N","S3C","S4"];
  steps.forEach((s, i) => {
    if (!STEPBAR_VISIBLE_IDS.includes(s.id)) return;
    const d = document.createElement("div");
    d.className = "step" + (i === idx ? " current" : (i < idx ? " done" : ""));
    d.textContent = s.name;
    d.onclick = () => { idx = i; saveFlowState(); render();  };
    bar.appendChild(d);
  });

  const step = steps[idx];
  el("stepTitle").textContent = step.name;

  if (step.id === "S2") el("openConsultBtn").classList.remove("hidden");
  else el("openConsultBtn").classList.add("hidden");

  // S5
if (step.id === "S5"){
  // ã¾ãšå…¨éƒ¨éš ã™
  el("warnBox").classList.add("hidden");
  el("nextBox").classList.add("hidden");
  el("doneChecklist").classList.add("hidden");
  if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
  if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");

  const nextIdx = findNextIncompleteLineIndex();

  // å…¨å›ç·šå®Œäº† â†’ ã„ã¤ã‚‚ã®ã€ŒãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€
  if (nextIdx < 0){
    el("multiFinishBox")?.classList.add("hidden");
    el("finishBox").classList.remove("hidden");
    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = true;
    return;
  }

  // æœªå®Œã®å›ç·šãŒæ®‹ã£ã¦ã‚‹ â†’ æ¬¡ã®å›ç·šã¸èª˜å°
  el("finishBox").classList.add("hidden");
  el("multiFinishBox")?.classList.remove("hidden");

  // æ–‡è¨€ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã§ã‚«ã‚¹ã‚¿ãƒ ï¼‰
  if (el("multiFinishText")){
    el("multiFinishText").textContent = `ã¾ã æœªå®Œã®å›ç·šãŒã‚ã‚Šã¾ã™ã€‚å›ç·š ${nextIdx+1} ã®å¥‘ç´„ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚`;
  }

  // ãƒœã‚¿ãƒ³å‹•ä½œ
  if (el("gotoNextLineBtn")){
    el("gotoNextLineBtn").onclick = () => gotoLine(nextIdx);
  }

  el("backBtn").disabled = (idx === 0);
  el("nextBtn").disabled = true;
  return;
}

  // S3 SIM-only checklist
  if (step.id === "S3" && ctx && ctx.contractType === "mnpSim"){
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
    el("s3SimChecklist").classList.remove("hidden");

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isS3SimChecklistComplete(ctx);
    return;
  } else {
    if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
  }

  // S3N checklist
  if (step.id === "S3N"){
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
    el("s3nChecklist").classList.remove("hidden");

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isS3NChecklistComplete(ctx);
    return;
  } else {
    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
  }

  // S4 done checklist
  if (step.id === "S4"){
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    el("doneChecklist").classList.remove("hidden");

    el("doneDataTransferItem").classList.toggle("hidden", ctx.needDataTransfer !== "yes");
    el("doneTradeInItem").classList.toggle("hidden", ctx.needTradeInReception !== "yes");

    const shared = ensureLines();
    const isLastLine = (activeLine === shared.lines.length - 1);
    const carItem = el("chk_done_car")?.closest(".checkitem");
    if (carItem) carItem.classList.toggle("hidden", !isLastLine);

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isDoneChecklistComplete(ctx);
    return;
  }

  // default: S1/S2/S3*/S3C
  el("doneChecklist").classList.add("hidden");
  el("finishBox").classList.add("hidden");

  const c = contentFor(step.id, ctx);
  const ul = el("warnList");
  ul.innerHTML = "";
  c.warn.forEach(t => {
    const li = document.createElement("li");
    li.textContent = t;
    if (t.startsWith("ã€è­¦å‘Šã€‘")) li.classList.add("red");
    ul.appendChild(li);
  });
  el("nextAction").textContent = c.next;

  el("warnBox").classList.remove("hidden");
  el("nextBox").classList.remove("hidden");

  el("backBtn").disabled = (idx === 0);
  el("nextBtn").disabled = (idx === steps.length - 1);
}

/* =========================
   Draft save/load (per line)
   ========================= */
function collectForm(){
  const shared = ensureLines(); // â˜…ã“ã‚ŒãŒå¿…è¦ï¼ˆsharedæœªå®šç¾©ã§æ­»ã‚“ã§ãŸï¼‰

  return {
    contractType: el("contractType").value,
    contractHolder: el("contractHolder").value,
    useDifferentUser: el("useDifferentUser").checked,
    userRelation: el("userRelation").value,

    idType: el("idType").value,
    carrier: el("carrier").value,
    housingType: el("housingType").value,
    dataUsage: el("dataUsage").value,
    usageYears: el("usageYears").value,

    // â˜…ä¸–å¸¯å…±é€š
    homeNetType:  (shared.houseNet?.homeNetType || ""),
    homeNetYears: (shared.houseNet?.homeNetYears || ""),
    housingType: (shared.houseNet?.housingType || ""),

    chk_id_confirmed: el("chk_id_confirmed").checked,
    chk_homeNet_asked: el("chk_homeNet_asked").checked,
    chk_tradein: el("chk_tradein").checked,
    tradeinResult: (el("tradeinResult") ? el("tradeinResult").value : "")
  };
}
function saveDraft(){
  const shared = ensureLines();

  // å›ç·šã”ã¨ã®ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¸–å¸¯å…±é€šã¯å«ã‚ãªã„ï¼‰
  shared.lines[activeLine].form = { ...collectForm() };

  // â˜…ä»£è¡¨ï¼ˆå›ç·š1ï¼‰ã§å…¥åŠ›ã•ã‚ŒãŸä¸–å¸¯æƒ…å ±ã‚’å…±é€šã«ä¿å­˜
  if (activeLine === 0){
    shared.houseNet.homeNetType  = el("homeNetType").value  || "";
    shared.houseNet.homeNetYears = el("homeNetYears").value || "";
    shared.houseNet.housingType  = el("housingType")?.value || "";
  }

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

function loadDraft(){
  const shared = ensureLines();
  const data = shared.lines[activeLine].form || {};
  const setVal = (id, v) => { if (v != null && el(id)) el(id).value = v; };

  setVal("contractType", data.contractType);
  updateTradeInVisibility();
  setVal("idType", data.idType);

  setVal("contractHolder", data.contractHolder ?? "self");

if (el("useDifferentUser")) el("useDifferentUser").checked = !!data.useDifferentUser;

// å…ˆã«åŒæœŸã—ã¦ disabled çŠ¶æ…‹ã‚’ä½œã£ã¦ã‹ã‚‰ userRelation ã‚’å¾©å…ƒ
syncUserRelationLock();
setVal("userRelation", data.userRelation ?? "self");

  setVal("userRelation", data.userRelation);
  setVal("carrier", data.carrier);
  setVal("housingType", data.housingType);
  setVal("dataUsage", data.dataUsage);
  setVal("usageYears", data.usageYears);
  setVal("homeNetType",  shared.houseNet.homeNetType  || "");
  setVal("homeNetYears", shared.houseNet.homeNetYears || "");
  setVal("housingType", shared.houseNet.housingType || "");

  el("chk_id_confirmed").checked = !!data.chk_id_confirmed;
  el("chk_homeNet_asked").checked = !!data.chk_homeNet_asked;
  el("chk_tradein").checked = !!data.chk_tradein;
  if (el("tradeinResult")) el("tradeinResult").value = data.tradeinResult || "";

  updateStartEnabled();
}

/* =========================
   Flow state save/restore
   ========================= */
function saveFlowState(){
  const shared = ensureLines();
  shared.lines[activeLine].flow.started = !!(ctx && idx >= 0);
  shared.lines[activeLine].flow.stepId  = (steps[idx] ? steps[idx].id : "S1");
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

function restoreCheckStatesFromLine(line){
  const s3 = line.s3 || {};
  ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"].forEach(id=>{
    if (el(id)) el(id).checked = !!s3[id];
  });

  const s3n = line.s3n || {};
  ["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"].forEach(id=>{
    if (el(id)) el(id).checked = !!s3n[id];
  });

  const s4 = line.s4 || {};
  ["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"].forEach(id=>{
    if (el(id)) el(id).checked = !!s4[id];
  });
}

function saveChecklistToLine(){
  const shared = ensureLines();
  const line = shared.lines[activeLine];

  line.s3 = line.s3 || {};
  ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"].forEach(id=>{
    if (el(id)) line.s3[id] = !!el(id).checked;
  });

  line.s3n = line.s3n || {};
  ["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"].forEach(id=>{
    if (el(id)) line.s3n[id] = !!el(id).checked;
  });

  line.s4 = line.s4 || {};
  ["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"].forEach(id=>{
    if (el(id)) line.s4[id] = !!el(id).checked;
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
}

function findNextIncompleteLineIndex(){
  const shared = ensureLines();
  // ã€ŒS5 ã˜ã‚ƒãªã„ã€= æœªå®Œ ã¨ã¿ãªã™ï¼ˆstarted=false ã‚‚æœªå®Œæ‰±ã„ï¼‰
  for (let i = 0; i < shared.lines.length; i++){
    const flow = shared.lines[i].flow || {};
    if (!flow.started) return i;
    if ((flow.stepId || "S1") !== "S5") return i;
  }
  return -1; // å…¨éƒ¨å®Œäº†
}

function gotoLine(i){
  saveDraft();
  saveFlowState();
  saveChecklistToLine();
  setActiveLine(i);
  syncFromStorage();
}

/* =========================
   Multi line bar
   ========================= */
function renderLinebar(){
  if (el("finishBox")) el("finishBox").classList.add("hidden");
  if (el("multiFinishBox")) el("multiFinishBox").classList.add("hidden");

  const linebar = el("linebar");
  if (!linebar) return;

  const shared = ensureLines();
  activeLine = Math.max(0, Math.min(shared.activeLine, shared.lines.length - 1));

  linebar.innerHTML = "";
  shared.lines.forEach((_, i)=>{
    const d = document.createElement("div");
    const isCur = (i === activeLine);
    d.className = "step" + (isCur ? " current" : "");
    d.textContent = `å›ç·š ${i+1}`;
    d.onclick = () => {
      saveDraft();
      saveFlowState();
      saveChecklistToLine();
      setActiveLine(i);
      syncFromStorage();
    };
    linebar.appendChild(d);
  });

  if (el("removeLineBtn")){
    el("removeLineBtn").disabled = (shared.lines.length <= 1);
  }
  renderLinebarMini();
}

function renderLinebarMini(){
  const bar = el("linebarMini");
  if (!bar) return;

  const shared = ensureLines();
  activeLine = Math.max(0, Math.min(shared.activeLine, shared.lines.length - 1));

  bar.innerHTML = "";
  shared.lines.forEach((_, i) => {
    const d = document.createElement("div");
    d.className = "step" + (i === activeLine ? " current" : "");
    d.textContent = `å›ç·š ${i+1}`;
    d.onclick = () => gotoLine(i);   // â˜…åˆ‡æ›¿ã®ã¿
    bar.appendChild(d);
  });
}

/* =========================
   Sync from storage
   ========================= */
function syncFromStorage(){
  const shared = ensureLines();
  activeLine = Math.max(0, Math.min(shared.activeLine, shared.lines.length - 1));
  const line = shared.lines[activeLine];

  loadDraft();
  restoreCheckStatesFromLine(line);

  const consult = line.consult || { payType:"", needDataTransfer:"no", needTradeInReception:"no" };
  const started = !!(line.flow && line.flow.started);

  if (!started){
    ctx = null; steps = []; idx = -1;
    render();
    renderLinebar();
    return;
  }

  ctx = {
    ...collectForm(),
    payType: consult.payType || "",
    needDataTransfer: consult.needDataTransfer || "no",
    needTradeInReception: consult.needTradeInReception || "no",
  };

  steps = buildSteps(ctx.contractType, ctx.payType);

  const savedId = (line.flow && line.flow.stepId) ? line.flow.stepId : "S1";
  let newIdx = steps.findIndex(s => s.id === savedId);
  if (newIdx < 0) newIdx = 0;
  idx = Math.max(0, Math.min(newIdx, steps.length - 1));

  restoreCheckStatesFromLine(line);

  render();
  renderLinebar();
}

const watchIds = [
  "contractType","contractHolder","idType",
  "useDifferentUser","userRelation",
  "carrier","usageYears","dataUsage","housingType",
  "homeNetType","homeNetYears"
];

/* =========================
   Events
   ========================= */
watchIds.forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    if (id === "contractType") updateTradeInVisibility();

    // â˜…ã“ã‚ŒãŒæœ¬å‘½
    syncUserRelationLock();   // åˆ©ç”¨è€…ãƒ­ãƒƒã‚¯å†åŒæœŸ
    updateStartEnabled();     // â† badge_credit / startBtn æ›´æ–°
    saveDraft();              // â† å®¶ãƒãƒƒãƒˆå…±é€šä¿å­˜ã‚‚ã“ã“ã§åæ˜ 
  });
});

["chk_id_confirmed","chk_homeNet_asked","chk_tradein"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    updateStartEnabled();
    saveDraft();
  });
});

["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    saveChecklistToLine();
    if (steps[idx] && steps[idx].id === "S3" && ctx && ctx.contractType === "mnpSim") render();
  });
});

["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    saveChecklistToLine();
    if (steps[idx] && steps[idx].id === "S3N") render();
  });
});

["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"]
  .forEach(id => {
    const node = el(id);
    if (!node) return;
    node.addEventListener("change", () => {
      saveChecklistToLine();
      if (steps[idx] && steps[idx].id === "S4") render();
    });
  });

if (el("tradeinResult")){
  el("tradeinResult").addEventListener("change", () => {
    updateStartEnabled();
    saveDraft();
  });
}

/* --- add/remove line buttons --- */
if (el("addLineBtn")){
  el("addLineBtn").onclick = () => {
    saveDraft(); saveFlowState(); saveChecklistToLine();

    const shared = ensureLines();
    const keep = shared.activeLine;
    shared.lines.push(blankLine());
    shared.activeLine = keep; 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));

    syncFromStorage();
  };
}

if (el("removeLineBtn")){
  el("removeLineBtn").onclick = () => {
    const shared = ensureLines();
    if (shared.lines.length <= 1) return;

    shared.lines.splice(activeLine, 1);
    shared.activeLine = Math.max(0, Math.min(activeLine, shared.lines.length - 1));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));

    syncFromStorage();
  };
}

// start/reset
el("startBtn").onclick = () => {
  if (!allSelected()) return;

  const shared = ensureLines();
  const line = shared.lines[activeLine];

  // é–‹å§‹æ™‚ï¼šã“ã®å›ç·šã®è³¼å…¥æ–¹æ³•ã ã‘ãƒªã‚»ãƒƒãƒˆ
  line.consult = { payType:"", needDataTransfer:"no", needTradeInReception:"no" };

  ctx = {
    ...collectForm(),
    payType: "",
    needDataTransfer: "no",
    needTradeInReception: "no",
  };

  steps = buildSteps(ctx.contractType, ctx.payType);
  idx = 0;

  line.flow = { started:true, stepId:"S1" };

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));
  render();
  renderLinebar();
};

el("resetBtn").onclick = () => {
  const shared = ensureLines();
  shared.lines[activeLine] = blankLine();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));

  ctx=null; steps=[]; idx=-1;
  syncFromStorage();
};

el("wipeAllBtn").onclick = () => {
  // 1å›ç›®ç¢ºèª
  if (!confirm("å…¨å›ç·šãƒ»ä¸–å¸¯å…±é€šã‚’å«ã‚ã€å…¥åŠ›ã¨é€²æ—ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

  localStorage.removeItem(STORAGE_KEY);

  // ãƒ¡ãƒ¢ãƒªä¸Šã®çŠ¶æ…‹ã‚‚åˆæœŸåŒ–
  ctx = null; steps = []; idx = -1;
  activeLine = 0;

  // åˆæœŸçŠ¶æ…‹ã‚’ä½œã‚Šç›´ã—ã¦æç”»
  syncFromStorage();
};

// nav
el("backBtn").onclick = () => { if (idx > 0) 
{ idx--; 
  saveFlowState(); 
  render(); 
} };
el("nextBtn").onclick = () => { if (idx < steps.length - 1) 
{ idx++; 
  saveFlowState();
  render();
} };

// consult open
// consult openï¼ˆä¿å­˜ã—ã¦ã‹ã‚‰é·ç§»ï¼‰
el("openConsultBtn").onclick = () => {
  // â˜… ã“ã“ã§ã€Œä»Šã®ç”»é¢ã®é¸æŠå€¤ã€ã‚’å¼·åˆ¶çš„ã« storage ã«æ›¸ã
  const shared = ensureLines();
  const form = collectForm();

  // å›ç·šã”ã¨ã® form ã‚’å¿…ãšæ›´æ–°
  shared.lines[activeLine].form = form;

  // äº’æ›ï¼šãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ã‚‚ãƒŸãƒ©ãƒ¼ï¼ˆå¤ã„å‚ç…§/ã‚³ãƒ³ã‚µãƒ«å´ã®ä¿é™ºï¼‰
  Object.assign(shared, form);

  // activeLine ã‚‚ç¢ºå®Ÿã«ä¿å­˜
  shared.activeLine = activeLine;

  // flow ã‚‚ä¿å­˜ï¼ˆä»»æ„ï¼‰
  if (shared.lines[activeLine].flow) {
    shared.lines[activeLine].flow.started = !!(ctx && idx >= 0);
    shared.lines[activeLine].flow.stepId = (steps[idx] ? steps[idx].id : "S1");
  }

  localStorage.setItem(STORAGE_KEY, JSON.stringify(shared));

  window.location.href = "ConsultingNavigator.html";
};

// help
if (el("helpBtn")){
  el("helpBtn").onclick = () => {
    window.location.href = "Readme.html";
  };
}

// bfcache / tab / storage
window.addEventListener("pageshow", () => syncFromStorage());
window.addEventListener("focus", () => syncFromStorage());
window.addEventListener("storage", (ev) => { if (ev.key === STORAGE_KEY) syncFromStorage(); });

/* =========================
   Init
   ========================= */
updateTradeInVisibility();
syncUserRelationLock();
updateStartEnabled();
syncFromStorage();
</script>
</body>
</html>