<!-- =========================
     ContractNavigator.html
     ========================= -->
<!-- ä½œæˆè€…ï¼šãƒã‚¸ãƒã€€ãƒãƒ«ã‚¨ãƒ„ç¨²æ¯›åº—ã€€é§’ è«’å¤§ -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¥‘ç´„ãƒŠãƒ“</title>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      margin:0;
      color:#111;
      font-size:17px;
      background: transparent;
    }

    html::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;

      background:
        linear-gradient(rgba(246,247,249,0.60), rgba(246,247,249,0.60)),
        url("consaru.jpg") center/150% repeat,
        #f6f7f9;
    }
    :root{
      --header-h: 200px; /* â† ã¨ã‚Šã‚ãˆãšã€‚ã‚ºãƒ¬ãŸã‚‰ã“ã“ã ã‘å¾®èª¿æ•´ */
    }

    html, body{
      height:100%;
      overflow:hidden;      /* â† ãƒšãƒ¼ã‚¸æœ¬ä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ãªã„ */
    }

    .wrap{
    height: calc(100vh - var(--header-h));
    overflow:auto;
    -webkit-overflow-scrolling: touch;

    max-width:960px;
    margin:0 auto;
    padding:12px 16px 40px;
    }

    .donebox{
      background:#f6fbff;
      border:1px solid #d6e8ff;
      border-radius:12px;
      padding:12px;
      margin-top:10px;
    }

    .donebox b{
      display:inline-block;
      margin-bottom:6px;
    }

    header{
      padding:16px 16px 8px;
      background:#fff;
      border-bottom:1px solid #e6e8eb;
      position:relative;
      top:0;
      z-index:10;
    }

    .helpBtn{
      position:absolute;
      top:26px;
      right:24px;

      width:26px;
      height:26px;
      border-radius:50%;

      border:1px solid #7f848a;
      background:#ffffff;
      color:#5e666e;

      font-size:15px;
      font-weight:900;
      line-height:1;
      cursor:pointer;

      box-shadow:0 1px 3px rgba(0,0,0,.15);
    }

    .helpBtn:active{
      transform:scale(0.96);
    }
    .title{font-size:24px;font-weight:800;}
    .sub{font-size:15px;color:#555;margin-top:4px;}
    .card{
      background:#fff;border:1px solid #e6e8eb;border-radius:14px;padding:14px;
      box-shadow:0 1px 2px rgba(0,0,0,.04);margin-top:12px;
    }
    .legal{color:#b00020;font-weight:800;}
    .state{font-size:20px;font-weight:800;}
    .muted{color:#555;font-size:14px;line-height:1.5;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{border:0;background:#111;color:#fff;border-radius:12px;padding:14px 16px;font-size:16px;cursor:pointer;}
    .btn:disabled{opacity:.4;cursor:not-allowed;}
    .btn2{border:1px solid #d9dde3;background:#fff;color:#111;border-radius:12px;padding:14px 16px;font-size:16px;cursor:pointer;}
    .stepbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .step{padding:10px 14px;border-radius:12px;background:#f0f2f5;font-size:16px;cursor:pointer;user-select:none;}
    .step.current{background:#dfe8ff;border:1px solid #9db6ff;}
    .step.done{background:#e7f7ea;border:1px solid #9fe0aa;}
    .warn{background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:12px;margin-top:10px;font-size:15px;}
    .warn b,.next b{display:inline-block;margin-bottom:6px;}
    .next{background:#f7f7ff;border:1px solid #d8ddff;border-radius:12px;padding:12px;margin-top:10px;}
    .hidden{display:none !important;}

    label{font-size:16px;color:#333;}
    select{
      width:100%;padding:14px 12px;border-radius:10px;border:1px solid #d9dde3;
      font-size:17px;background:#fff;
    }
    .grid{display:grid;gap:10px;margin-top:10px;}
    @media (min-width: 760px){
      .grid{grid-template-columns: 1fr 1fr;}
    }
    .divider{height:1px;background:#eef0f3;margin:12px 0;}
    .badge{
      display:inline-block;font-size:17px;padding:8px 16px;border-radius:999px;
      background:#f0f2f5;border:1px solid #e0e4ea;color:#333;
    }
    .badge.done{
      background:#e7f7ea;
      border:1px solid #9fe0aa;
      color:#1b5e20;
      font-weight:800;
    }

    .finishWrap{
      position: relative;
      max-width: 300px;
      margin: 0 auto;
      padding: 14px;
      background: #67abec;
      border-radius: 14px;
      border: 1px solid #67abec;
    }

    .finishWrap img{
      width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
    }

    /* ç”»åƒä¸Šãƒ†ã‚­ã‚¹ãƒˆ */
    .finishText{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffffff;
      font-size: 40px;
      font-weight: 900;
      letter-spacing: 0.08em;
      text-shadow:
        0 2px 6px rgba(0,0,0,0.35),   /* ç™½æ–‡å­—ãŒæ½°ã‚Œãªã„ */
        0 0 10px rgba(0,0,0,0.25);
      pointer-events: none;          /* ã‚¯ãƒªãƒƒã‚¯é‚ªé­”ã—ãªã„ */
    }

    /* check list */
    .checklist{margin-top:10px;display:flex;flex-direction:column;gap:8px;}
    .checkitem{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid #e6e8eb;border-radius:12px;padding:10px 12px;background:#fff;
    }
    .checkitem input{margin-top:2px;transform:scale(1.2);}
    .checkitem .ctitle{font-size:15px;font-weight:700;}
    .checkitem .csub{font-size:14px;color:#555;margin-top:2px;line-height:1.35;}

    /* red warning */
    .alert{
      background:#fff5f5;border:1px solid #ffd2d2;border-radius:12px;padding:10px 12px;margin-top:10px;
      color:#b00020;font-size:15px;font-weight:700;
    }
    .red{color:#b00020;font-size:15px;font-weight:800;}

    #navRow button{min-height:48px;}

    /* summary éè¡¨ç¤ºï¼ˆé‚ªé­”ï¼‰ */
    #summaryText { display:none !important; }
  </style>
</head>
<body>
<header>
  <div class="title">å¥‘ç´„ãƒŠãƒ“</div>
  <div class="sub">ã€Œä»Šã©ã“ï¼Ÿ æ³¨æ„ç‚¹ã¯ï¼Ÿ æ¬¡ã¯ä½•ï¼Ÿã€å¥‘ç´„ã®ãƒ•ãƒ­ãƒ¼ã‚’1ç”»é¢ã§ç¢ºèª</div>
  <button id="helpBtn" class="helpBtn">i</button>
</header>

<div class="wrap">
  <!-- å…¥å£ï¼šæ¡ä»¶é¸æŠï¼ˆåˆ†å²ã®å…ƒï¼‰ -->
  <div class="card">
    <div class="state">ğŸ“‹ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆ</div>

    <div class="divider"></div>

    <div class="row" style="gap:8px;">
      <span class="badge" id="badge_basic">åŸºæœ¬æ¡ä»¶</span>
    </div>

    <div class="grid">
      <div>
        <label>å¥‘ç´„ã‚¿ã‚¤ãƒ—</label>
        <select id="contractType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="mnpDevice">MNPï¼ˆç«¯æœ«ã‚ã‚Šï¼‰</option>
          <option value="mnpSim">MNPï¼ˆSIMã®ã¿ï¼‰</option>
          <option value="deviceChange">æ©Ÿç¨®å¤‰æ›´</option>
        </select>
      </div>

      <div>
        <label>å¹´é½¢åŒºåˆ†</label>
        <select id="ageType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="adult">æˆå¹´</option>
          <option value="minor">æœªæˆå¹´</option>
        </select>
      </div>

      <div>
        <label>ã”åˆ©ç”¨è€…æ§˜</label>
        <select id="userRelation">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="self">ã”æœ¬äºº</option>
          <option value="spouse">é…å¶è€…</option>
          <option value="child">ãŠå­æ§˜</option>
          <option value="parent">ã”ä¸¡è¦ª</option>
          <option value="other">ãã®ä»–</option>
        </select>
      </div>

      <div>
        <label>æœ¬äººç¢ºèªæ›¸é¡</label>
        <select id="idType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="license">é‹è»¢å…è¨±è¨¼</option>
          <option value="myNumber">ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row" style="gap:8px;">
      <span class="badge" id="badge_credit">ä¸ä¿¡æ™‚ç‚¹ã®ç¢ºèª</span>
    </div>

    <div class="grid">
      <div>
        <label>ç¾åœ¨ãŠä½¿ã„ã®ã‚­ãƒ£ãƒªã‚¢</label>
        <select id="carrier">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="docomo">docomo</option>
          <option value="ahamo">ahamo</option>
          <option value="au">au</option>
          <option value="uq">UQ mobile</option>
          <option value="softbank">SoftBank</option>
          <option value="ymobile">Y!mobile</option>
          <option value="other">ãã®ä»–</option>
        </select>
      </div>

      <div>
        <label>ç«¯æœ«ã®è³¼å…¥å…ˆ</label>
        <select id="deviceFrom">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="nojima">ãƒã‚¸ãƒ</option>
          <option value="carrier">ã‚­ãƒ£ãƒªã‚¢</option>
          <option value="unknown">ãã®ä»–</option>
        </select>
      </div>

      <div>
        <label>æœˆã®ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ï¼ˆç›®å®‰ï¼‰</label>
        <select id="dataUsage">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="lte5">ã€œ5GB</option>
          <option value="lte30">ã€œ30GB</option>
          <option value="unlimited">30GBä»¥ä¸Šï¼ˆç„¡åˆ¶é™ï¼‰</option>
        </select>
      </div>

      <div>
        <label>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå›ç·š</label>
        <select id="homeNetType">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="fletshikari">ãƒ•ãƒ¬ãƒƒãƒ„å…‰</option>
          <option value="nurohikari">NUROå…‰</option>
          <option value="docomohikari">ãƒ‰ã‚³ãƒ¢å…‰</option>
          <option value="niftyhikari">@niftyå…‰</option>
          <option value="softbankhikari">ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯å…‰</option>
          <option value="auhikari">auã²ã‹ã‚Š</option>
          <option value="jcom">J:COM</option>
          <option value="home5g">ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ã‚¿ãƒ¼</option>
          <option value="unknown">ãã®ä»–</option>
          <option value="none">ã”åˆ©ç”¨ãªã—</option>
        </select>
      </div>

      <div>
        <label>åˆ©ç”¨å¹´æ•°ï¼ˆã‚¹ãƒãƒ›ã‚­ãƒ£ãƒªã‚¢ï¼‰</label>
        <select id="usageYears">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="lt6m">åŠå¹´æœªæº€</option>
          <option value="6to12m">åŠå¹´ã€œ1å¹´</option>
          <option value="gt12m">1å¹´ä»¥ä¸Š</option>
        </select>
      </div>

      <div>
        <label>åˆ©ç”¨å¹´æ•°ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå›ç·šï¼‰</label>
        <select id="homeNetYears">
          <option value="" selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="lt12m">1å¹´æœªæº€</option>
          <option value="gt12m">1å¹´ä»¥ä¸Š</option>
          <option value="unknown">ä¸æ˜</option>
        </select>
      </div>
    </div>

    <!-- ãƒã‚§ãƒƒã‚¯ï¼ˆé–‹å§‹å‰ï¼‰ -->
    <div class="divider"></div>
    <div class="row" style="gap:8px;">
      <span class="badge" id="badge_check">ç¢ºèªãƒã‚§ãƒƒã‚¯</span>
    </div>

    <div class="checklist">
      <div class="checkitem">
        <input type="checkbox" id="chk_id_confirmed" />
        <div>
          <div class="ctitle">æœ¬äººç¢ºèªæ›¸é¡ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
          <div class="csub">æ°åï¼ç”Ÿå¹´æœˆæ—¥ï¼ä½æ‰€ãªã©</div>
        </div>
      </div>

      <div class="checkitem">
        <input type="checkbox" id="chk_homeNet_asked" />
        <div>
          <div class="ctitle">ã‚­ãƒ£ãƒªã‚¢ãŠã‚ˆã³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå›ç·šã®åˆ©ç”¨å¹´æ•°ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
          <div class="csub">ã€ŒåŠå¹´ä»¥ä¸ŠãŠä½¿ã„ã§ã™ã‹ï¼Ÿã€ãªã©ã€ãƒ’ã‚¢ãƒªãƒ³ã‚°æ¸ˆã¿</div>
        </div>
      </div>
    </div>

    <!-- ç«¯æœ«ã‚ã‚Šã®ã¨ãã ã‘ï¼šä¸‹å–ã‚Šç¢ºèª -->
    <div class="checklist hidden" id="tradeinBlock">
      <div class="checkitem">
        <input type="checkbox" id="chk_tradein" />
        <div style="flex:1;">
          <div class="ctitle">ç«¯æœ«ä¸‹å–ã‚Šã®å¯å¦ã‚’ç¢ºèªã—ã¾ã—ãŸ</div>
          <div class="csub">åˆ†å‰²ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã”åˆ©ç”¨ã®å ´åˆã€ç«¯æœ«ã®æ®‹å‚µã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
        </div>

        <!-- â˜…è¿½åŠ ï¼šä¸‹å–ã‚Š OK/NG -->
        <select id="tradeinResult" style="width:140px; padding:10px 10px; border-radius:10px;">
          <option value="" selected>æœªé¸æŠ</option>
          <option value="ok">ä¸‹å–ã‚ŠOK</option>
          <option value="ng">ä¸‹å–ã‚ŠNG</option>
        </select>
      </div>
    </div>

    <!-- å³æ™‚è­¦å‘Šï¼ˆé–‹å§‹å‰ï¼‰ -->
    <div class="alert hidden" id="preAlert"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" id="startBtn" disabled>ã“ã®æ¡ä»¶ã§é–‹å§‹</button>
      <button class="btn2" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒ¼ -->
  <div class="card">
    <div class="state">ğŸ“ç¾åœ¨åœ°</div>
    <div class="stepbar" id="stepbar"></div>
    <div class="muted" id="summaryText">æ¡ä»¶ã‚’é¸ã‚“ã§é–‹å§‹ã—ã¦ãã ã•ã„</div>
  </div>

  <!-- ã‚¹ãƒ†ãƒƒãƒ—å†…å®¹ -->
  <div class="card" id="stepCard">
    <div class="state" id="stepTitle">é–‹å§‹ã—ã¦ãã ã•ã„</div>

    <div class="warn hidden" id="warnBox">
      <b>âš  ã“ã“ã§ã®æ³¨æ„</b>
      <ul id="warnList" style="margin:0 0 0 18px;"></ul>
    </div>

    <div class="next hidden" id="nextBox">
      <b>ğŸ‘‰ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</b>
      <div id="nextAction" style="margin-top:6px;"></div>
    </div>

<!-- S3: MNP(SIMã®ã¿ï¼‰å¥‘ç´„ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="s3SimChecklist">
  <div class="checklist" style="margin-top:8px;">

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_mnp" />
      <div>
        <div class="ctitle">MNPäºˆç´„ç•ªå·ã®å–å¾—</div>
        <div class="csub">å–å¾—æ¸ˆã¿ãªã‚‰OKã€€è¤‡é›‘ãªå ´åˆã¯é›»è©±ã§</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_docs" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®ãŠé ã‹ã‚Š</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ã®ãŸã‚</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_input" />
      <div>
        <div class="ctitle">å¥‘ç´„æƒ…å ±ã‚’å…¥åŠ›</div>
        <div class="csub">æ°åã‚„ç”Ÿå¹´æœˆæ—¥ãªã©ã®å…¥åŠ›ãƒŸã‚¹ã«æ³¨æ„</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3sim_notice" />
      <div>
        <div class="ctitle">é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã®ã”æ¡ˆå†…</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ä¸­ã«ã”è¦§ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚º</div>
      </div>
    </div>

  </div>
</div>

<!-- S3N: åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="s3nChecklist">
  <div class="checklist" style="margin-top:8px;">
    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_mnp" />
      <div>
        <div class="ctitle">MNPäºˆç´„ç•ªå·ã®å–å¾—</div>
        <div class="csub">å–å¾—æ¸ˆã¿ãªã‚‰OKã€€è¤‡é›‘ãªå ´åˆã¯é›»è©±ã§</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_prepare" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®ãŠé ã‹ã‚Š</div>
        <div class="csub">åˆ†ãƒªã‚»ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã®ã¿å¯ï¼ˆå¾Œæ—¥ç™»éŒ²å¯ï¼‰</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_apply" />
      <div>
        <div class="ctitle">åˆ†ãƒªã‚»ã®ç”³è«‹</div>
        <div class="csub">ãƒ¢ãƒã‚¤ãƒ« â†’ å†…å®¹ç¢ºèª â†’ åˆ†ãƒªã‚»ç”¨QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_input" />
      <div>
        <div class="ctitle">å¥‘ç´„æƒ…å ±ã‚’å…¥åŠ›</div>
        <div class="csub">æ°åã‚„ç”Ÿå¹´æœˆæ—¥ãªã©ã®å…¥åŠ›ãƒŸã‚¹ã«æ³¨æ„ã€€<span class="legal">å¯©æŸ»çµæœãŒå‡ºã‚‹ã¾ã§ã¯ç¢ºå®šã—ãªã„</span></div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_video" />
      <div>
        <div class="ctitle">é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã®ã”æ¡ˆå†…</div>
        <div class="csub">å¥‘ç´„æƒ…å ±å…¥åŠ›ä¸­ã«ã”è¦§ã„ãŸã ãã¨ã‚¹ãƒ ãƒ¼ã‚º</div>
      </div>
    </div>

    <div class="checkitem">
      <input type="checkbox" id="chk_s3n_result" />
      <div>
        <div class="ctitle">å¯©æŸ»çµæœã‚’ç¢ºèª</div>
        <div class="csub">OKãªã‚‰å¥‘ç´„ç¢ºå®šã¸ï¼NGãªã‚‰ä»£æ›¿æ¡ˆã¸</div>
      </div>
    </div>
  </div>
</div>

    <!-- å¥‘ç´„å¾Œå¯¾å¿œã€€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
<div class="donebox hidden" id="doneChecklist">
  <div class="checklist" style="margin-top:8px;">
    <div class="checkitem">
      <input type="checkbox" id="chk_done_return" />
      <div>
        <div class="ctitle">ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰ã®è¿”å´</div>
        <div class="csub">å…è¨±è¨¼ï¼ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ï¼ã‚¯ãƒ¬ã‚«ç­‰ã®è¿”ã—å¿˜ã‚Œé˜²æ­¢</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_open" />
      <div>
        <div class="ctitle">é–‹é€šç¢ºèª</div>
        <div class="csub">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡ï¼ç™ºç€ä¿¡</div>
      </div>
    </div>
    <div class="checkitem hidden" id="doneDataTransferItem">
      <input type="checkbox" id="chk_done_datatransfer" />
      <div>
        <div class="ctitle">ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</div>
        <div class="csub">æ–°ã—ã„ç«¯æœ«ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ä¸å…·åˆé˜²æ­¢</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_point" />
      <div>
        <div class="ctitle">POSã§ã®ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãŠã‚ˆã³ãŠä¼šè¨ˆ</div>
        <div class="csub">ãƒ¢ãƒã‚¤ãƒ«QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æ™‚é–“ã‚„èª¤ç´ã¥ã‘ã«æ³¨æ„</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_consent" />
      <div>
        <div class="ctitle">ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒåŒæ„æ›¸ã®è¨˜å…¥</div>
        <div class="csub">ç¢ºèªäº‹é …ã®ãƒã‚§ãƒƒã‚¯ã¨ç½²å</div>
      </div>
    </div>
    <div class="checkitem hidden" id="doneTradeInItem">
      <input type="checkbox" id="chk_done_tradein" />
      <div>
        <div class="ctitle">å¤ç‰©ä¸‹å–ã‚Šå—ä»˜</div>
        <div class="csub">å½“æ—¥å—ä»˜ï¼å¾Œæ—¥å—ä»˜ã¯2é€±é–“ä»¥å†…</div>
      </div>
    </div>
    <div class="checkitem">
      <input type="checkbox" id="chk_done_car" />
      <div>
        <div class="ctitle">ãŠè»Šã®ã”åˆ©ç”¨ã‚’ç¢ºèª</div>
        <div class="csub">2æ™‚é–“é§è»Šåˆ¸ã®ãŠæ¸¡ã—ã€€è¶…éæ™‚ã¯ãƒãƒ«ã‚¨ãƒ„ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¸èª˜å°</div>
      </div>
    </div>
  </div>
</div>

<!-- å®Œäº†ç”»é¢ï¼ˆS5ã®ã¿è¡¨ç¤ºï¼‰ -->
<div class="donebox hidden" id="finishBox" style="text-align:center;">
  <div class="finishWrap">
    <div class="finishText">Completed!</div>
    <img
      src="otsukare.png"
      alt="ãŠç–²ã‚Œã•ã¾ã§ã—ãŸ"
      onerror="this.style.display='none'; document.getElementById('finishFallback').classList.remove('hidden');"
    />
  </div>
</div>

    <div class="row" id="navRow" style="margin-top:12px; align-items:center; width:100%;">
      <div class="row" style="gap:10px;">
        <button class="btn2" id="backBtn">â† æˆ»ã‚‹</button>
        <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      </div>

      <div style="flex:1;"></div>

      <button class="btn2 hidden" id="openConsultBtn">ã‚³ãƒ³ã‚µãƒ«ãƒ„ãƒ¼ãƒ« â†—</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Shared Storage
   ========================= */
const STORAGE_KEY = "contract_navi_ctx_v1";
const FLOW_STARTED_KEY = "__flow_started";
const FLOW_STEPID_KEY  = "__flow_step_id";

/* =========================
   Helpers
   ========================= */
const el = (id) => document.getElementById(id);

function needsDeviceFlow(ct){
  return ct === "deviceChange" || ct === "mnpDevice";
}

function readShared(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return {};
  try { return JSON.parse(raw) || {}; } catch(e){ return {}; }
}

function writeShared(patch){
  const cur = readShared();
  const next = { ...cur, ...patch };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
  return next;
}

/* =========================
   Labels
   ========================= */
function labelCarrier(v){
  return ({
    docomo:"docomo", ahamo:"ahamo", au:"au", uq:"UQ mobile",
    softbank:"SoftBank", ymobile:"Y!mobile", other:"ãã®ä»–"
  })[v] || v;
}
function labelUsageYears(v){
  return ({ lt6m:"åŠå¹´æœªæº€", "6to12m":"åŠå¹´ã€œ1å¹´", gt12m:"1å¹´ä»¥ä¸Š" })[v] || v;
}
function labelDataUsage(v){
  return ({ lte5:"ã€œ5GB", lte30:"ã€œ30GB", unlimited:"30GBä»¥ä¸Šï¼ˆç„¡åˆ¶é™ï¼‰" })[v] || v;
}
function labelDeviceFrom(v){
  return ({ nojima:"ãƒã‚¸ãƒ", carrier:"ã‚­ãƒ£ãƒªã‚¢", unknown:"ãã®ä»–" })[v] || v;
}
function labelIdType(v){
  return ({ license:"é‹è»¢å…è¨±è¨¼", myNumber:"ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰", student:"å­¦ç”Ÿè¨¼"})[v] || v;
}
function labelUserRelation(v){
  return ({ self:"ã”æœ¬äºº", spouse:"é…å¶è€…", child:"ãŠå­æ§˜", parent:"ã”ä¸¡è¦ª", other:"ãã®ä»–" })[v] || v;
}
function labelHomeNetType(v){
  return ({
    docomohikari:"ãƒ‰ã‚³ãƒ¢å…‰", niftyhikari:"@niftyå…‰", softbankhikari:"ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯å…‰",
    otherntthikari:"ãã®ä»–ã‚³ãƒ©ãƒœå…‰", auhikari:"auã²ã‹ã‚Š", jcom:"J:COM",
    nurohikari:"NUROå…‰", fletshikari:"ãƒ•ãƒ¬ãƒƒãƒ„å…‰", home5g:"ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ã‚¿",
    mobile:"ãƒ¢ãƒã‚¤ãƒ«ãƒ«ãƒ¼ã‚¿", none:"ãªã—", unknown:"ä¸æ˜"
  })[v] || v;
}
function labelHomeNetYears(v){
  return ({ lt12m:"1å¹´æœªæº€", gt12m:"1å¹´ä»¥ä¸Š", unknown:"ä¸æ˜" })[v] || v;
}
function labelPayType(v){
  return ({
    nojimaInstall:"ãƒã‚¸ãƒåˆ†å‰²",
    carrierInstall:"ã‚­ãƒ£ãƒªã‚¢åˆ†å‰²",
    lump:"ä¸€æ‹¬"
  })[v] || v;
}

/* =========================
   State
   ========================= */
let ctx = null;
let steps = [];
let idx = -1;

/* =========================
   Steps
   - ç«¯æœ«ã‚ã‚Šã§ã‚‚ payType æœªæ±ºå®šãªã‚‰ S1,S2ã¾ã§
   ========================= */
function buildSteps(contractType, payType) {
  const s = [];
  s.push({ id: "S1", name: "1. ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆä¸ä¿¡ï¼‰" });
  s.push({ id: "S2", name: "2. ãƒ—ãƒ©ãƒ³ã®ã‚³ãƒ³ã‚µãƒ«" });

  // ç«¯æœ«ãªã—
  if (!needsDeviceFlow(contractType)) {
    s.push({ id: "S3", name: "3. å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  // ç«¯æœ«ã‚ã‚Šï¼šè³¼å…¥æ–¹æ³•ãŒæœªæ±ºå®šãªã‚‰ã“ã“ã§æ­¢ã‚ã‚‹
  if (!payType) return s;

  // ãƒã‚¸ãƒåˆ†å‰²ï¼šå¥‘ç´„å‰ã«å¯©æŸ»
  if (payType === "nojimaInstall") {
    s.push({ id: "S3N", name: "3. åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„" });
    s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  // ã‚­ãƒ£ãƒªã‚¢åˆ†å‰²ï¼šå¥‘ç´„å…¥åŠ›â†’å¯©æŸ»ï¼ˆå¥‘ç´„ä¸­ï¼‰â†’å®Œäº†
  if (payType === "carrierInstall") {
    s.push({ id: "S3C",    name: "3. åˆ†å‰²å¯©æŸ»ãƒ»å¥‘ç´„" });
    s.push({ id: "S4",    name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
    s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
    return s;
  }

  // ä¸€æ‹¬ï¼šå¯©æŸ»ãªã—
  s.push({ id: "S3", name: "3. å¥‘ç´„" });
  s.push({ id: "S4", name: "4. å¥‘ç´„å¾Œå¯¾å¿œ" });
  s.push({ id: "S5", name: "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼" });
  return s;
}

/* =========================
   Business logic
   ========================= */
function isUpgradeBlocked(tmp){
  const mobileShort = (tmp.usageYears === "lt6m");
  const homeShort   = (tmp.homeNetYears === "lt12m");
  return { blocked: (mobileShort || homeShort), mobileShort, homeShort };
}

function isMnp(ct){
  return ct === "mnpDevice" || ct === "mnpSim";
}

/* =========================
   UI: badges / preAlert
   ========================= */
function updateTradeInVisibility(){
  const ct = el("contractType").value;
  const block = el("tradeinBlock");
  if (needsDeviceFlow(ct)){
    block.classList.remove("hidden");
  } else {
    el("chk_tradein").checked = false;
    if (el("tradeinResult")) el("tradeinResult").value = "";
    block.classList.add("hidden");
  }
  updateBadges();
}

function updateIdOptionsByAge(){
  const isMinor = el("ageType").value === "minor";
  const sel = el("idType");
  const hasStudent = !!sel.querySelector('option[value="student"]');

  if (isMinor && !hasStudent){
    const opt = document.createElement("option");
    opt.value = "student";
    opt.textContent = "å­¦ç”Ÿè¨¼";
    sel.appendChild(opt);
  }
  if (!isMinor && hasStudent){
    if (sel.value === "student") sel.value = "";
    sel.querySelector('option[value="student"]').remove();
  }
}

function sectionDone(ids){
  return ids.every(id => {
    const node = el(id);
    if (!node) return false;
    if (node.type === "checkbox") return node.checked;
    return (node.value || "").trim() !== "";
  });
}

function setDone(id, ok){
  const b = el(id);
  if (!b) return;
  b.classList.toggle("done", ok);
}

function updateBadges(){
  const basicOk  = sectionDone(["contractType","ageType","idType","userRelation"]);
  const creditOk = sectionDone(["carrier","usageYears","dataUsage","deviceFrom","homeNetType","homeNetYears"]);
  setDone("badge_basic",  basicOk);
  setDone("badge_credit", creditOk);

  const ct = el("contractType").value;
  const baseChecksOk = sectionDone(["chk_id_confirmed","chk_homeNet_asked"]);
  const tradeOk = needsDeviceFlow(ct)
    ? (el("chk_tradein").checked && (el("tradeinResult") ? (el("tradeinResult").value || "").trim() !== "" : false))
    : true;

  setDone("badge_check", baseChecksOk && tradeOk);
}

function updatePreAlert(){
  const box = el("preAlert");
  const ready = ["usageYears","homeNetYears"].every(id => (el(id).value || "").trim() !== "");
  if (!ready){
    box.classList.add("hidden");
    box.textContent = "";
    return;
  }
  const tmp = { usageYears: el("usageYears").value, homeNetYears: el("homeNetYears").value };
  const r = isUpgradeBlocked(tmp);
  if (r.blocked){
    const parts = [];
    if (r.mobileShort) parts.push("ã‚¹ãƒãƒ›ã‚­ãƒ£ãƒªã‚¢åˆ©ç”¨ãŒåŠå¹´æœªæº€");
    if (r.homeShort) parts.push("è‡ªå®…å›ç·šåˆ©ç”¨ãŒ1å¹´æœªæº€");
    box.textContent = `ã€è­¦å‘Šã€‘${parts.join(" ã¾ãŸã¯ ")}ã®ãŸã‚ã€ä¹—ã‚Šæ›ãˆã¯ä¸å¯ã¨ãªã‚Šã¾ã™`;
    box.classList.remove("hidden");
  } else {
    box.classList.add("hidden");
    box.textContent = "";
  }
}

function allSelected(){
  const requiredSelects = [
    "contractType","ageType","idType","userRelation",
    "carrier","usageYears","dataUsage","deviceFrom",
    "homeNetType","homeNetYears"
  ];
  const okSel = requiredSelects.every(id => (el(id).value || "").trim() !== "");
  if (!okSel) return false;

  if (!el("chk_id_confirmed").checked) return false;
  if (!el("chk_homeNet_asked").checked) return false;

  const ct = el("contractType").value;
  if (needsDeviceFlow(ct)){
    if (!el("chk_tradein").checked) return false;
    if (!el("tradeinResult") || (el("tradeinResult").value || "").trim() === "") return false;
  }

  return true;
}

function updateStartEnabled(){
  el("startBtn").disabled = !allSelected();
  updatePreAlert();
  updateBadges();
}

/* =========================
   Step content
   ========================= */
function contentFor(stepId, ctx){
  const warn = [];
  let next = "";
  const isMinor = (ctx.ageType === "minor");

  if (stepId === "S1"){
    const r = isUpgradeBlocked(ctx);
    if (r.blocked){
      const parts = [];
      if (r.mobileShort) parts.push("ã‚¹ãƒãƒ›ã‚­ãƒ£ãƒªã‚¢åˆ©ç”¨ãŒåŠå¹´æœªæº€");
      if (r.homeShort) parts.push("è‡ªå®…å›ç·šåˆ©ç”¨ãŒ1å¹´æœªæº€");
      warn.push(`ã€è­¦å‘Šã€‘${parts.join(" ã¾ãŸã¯ ")}ã®ãŸã‚ã€ä¹—ã‚Šæ›ãˆã¯ä¸å¯ã¨ãªã‚Šã¾ã™`);
    }
    warn.push("ä¸ä¿¡ã«ã¯ã”æœ¬äººç¢ºèªæ›¸é¡ãŒå¿…è¦ã§ã™");
    if(needsDeviceFlow(ctx.contractType)) warn.push("åˆ†å‰²ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã”åˆ©ç”¨ã®å ´åˆã€ç«¯æœ«ã®æ®‹å‚µã‚’ç¢ºèª");

    if (ctx.userRelation !== "self") warn.push("ã”åˆ©ç”¨è€…æ§˜ãŒã”æœ¬äººä»¥å¤–ï¼šå¥‘ç´„åç¾©ãƒ»åŒæ„/ç¢ºèªäº‹é …ã®æ•´ç†ãŒå¿…è¦ã§ã™");
    if (ctx.homeNetType === "none") warn.push("è‡ªå®…å›ç·šãªã—ï¼šå¿…è¦ãªã‚‰å›ç·šææ¡ˆã®æœ‰ç„¡ã‚’ç¢ºèª");
    if (isMinor) warn.push("æœªæˆå¹´ã®å ´åˆï¼šãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã®åŠ å…¥ãŒåŸå‰‡å¿…è¦ã¨ãªã‚Šã¾ã™");

    next = "ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚’ã‚‚ã¨ã«ãƒ—ãƒ©ãƒ³ã®ã‚³ãƒ³ã‚µãƒ«ã‚’è¡Œã†";
  }

  if (stepId === "S2"){
    warn.push("æ–½ç­–ã®é©ç”¨æ¡ä»¶ã‚„å¿…é ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ç­‰ã‚’æ˜ç¢ºã«ã”èª¬æ˜ã™ã‚‹");

    
    if (ctx.dataUsage === "lte5") warn.push("ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ãŒå°‘ãªã‚æƒ³å®šï¼ˆï½5GBï¼‰");
    if (ctx.dataUsage === "lte30") warn.push("ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡ãŒä¸­ç¨‹åº¦æƒ³å®š(ï½30GBï¼‰");
    if (ctx.dataUsage === "unlimited") warn.push("ç„¡åˆ¶é™ãƒ—ãƒ©ãƒ³æƒ³å®š");
    if (ctx.carrier === "uq" && (ctx.usageYears === "6to12m" || ctx.usageYears === "gt12m")){
      warn.push("UQ mobile ã‚’6ã‹æœˆä»¥ä¸Šåˆ©ç”¨ï¼šauã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰²å¼•ã®å¯¾è±¡ç¢ºèª");
    }
    if (ctx.carrier === "ymobile" && (ctx.usageYears === "6to12m" || ctx.usageYears === "gt12m")){
      warn.push("Y!mobile ã‚’6ã‹æœˆä»¥ä¸Šåˆ©ç”¨ï¼šSoftBankã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰²å¼•ã®å¯¾è±¡ç¢ºèª");
    }

    if (needsDeviceFlow(ctx.contractType) && !ctx.payType){
      next = "ã‚³ãƒ³ã‚µãƒ«ãƒ„ãƒ¼ãƒ«ã§è³¼å…¥æ–¹æ³•ã‚’é¸æŠã™ã‚‹";
    } else if (!needsDeviceFlow(ctx.contractType)){
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€å¥‘ç´„ã¸é€²ã‚€";
    } else if (ctx.payType === "nojimaInstall"){
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€åˆ†ãƒªã‚»å¯©æŸ»ãƒ»å¥‘ç´„ã¸é€²ã‚€";
    } else {
      next = "ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã—ã€å¥‘ç´„ã¸é€²ã‚€";
    }
    
  }

  if (stepId === "S3"){
    warn.push("ã”æœ¬äººç¢ºèªæ›¸é¡ãŠã‚ˆã³ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ã‚’ãŠé ã‹ã‚Šã™ã‚‹");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¥‘ç´„ã‚’å®Œäº†ã—ã€å¥‘ç´„å¾Œå¯¾å¿œã«é€²ã‚€";
  }

  if (stepId === "S3N"){
    warn.push("ãŠå®¢æ§˜ã®ãƒ¢ãƒã‚¤ãƒ«QRã‚³ãƒ¼ãƒ‰ã‚’ã„ãŸã ãã€åˆ†å‰²ã®ç”³è«‹ã‚’è¡Œã†");
    warn.push("å¯©æŸ»ã¨ä¸¦è¡Œã—ã¦å¥‘ç´„å…¥åŠ›ã‚’è¡Œã†ãŒã€å¯©æŸ»çµæœãŒå‡ºã‚‹ã¾ã§ã¯ç™»éŒ²ã‚’ç¢ºå®šã—ãªã„");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¯©æŸ»çµæœã‚’ç¢ºèªå¾Œã€å¥‘ç´„ã‚’å®Œäº†ã™ã‚‹";
  }

  if (stepId === "S3C"){
    warn.push("å¯©æŸ»çµæœã«ã‚ˆã‚Šã€åˆ†å‰²ä¸å¯â†’ä¸€æ‹¬ã®ã¿ã¨ãªã‚‹å¯èƒ½æ€§ã‚‚");
    warn.push("ãŠå®¢æ§˜ã«ã¯ã“ã®é–“ã«é‡è¦äº‹é …èª¬æ˜å‹•ç”»ã‚’ã”è¦§ã„ãŸã ã");
    next = "å¯©æŸ»çµæœã‚’ç¢ºèªå¾Œã€å¥‘ç´„ã‚’å®Œäº†ã™ã‚‹";
  }

  if (stepId === "S4"){
    warn.push("ã”æœ¬äººç¢ºèªæ›¸é¡ãƒ»ã‚«ãƒ¼ãƒ‰é¡ã‚’ç¢ºå®Ÿã«ãŠè¿”ã—ã™ã‚‹");
    warn.push("ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒåŒæ„æ›¸ã«ã”ç½²åã„ãŸã ã");
    next = "é–‹é€šç¢ºèªã‚„ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’è¡Œã†";
  }

  return { warn, next };
}

function requiredDoneIds(curCtx){
  const ids = ["chk_done_return","chk_done_open","chk_done_point","chk_done_consent","chk_done_car"];

  // ç«¯æœ«ã‚ã‚Š ã‹ã¤ ã‚³ãƒ³ã‚µãƒ«ã§ã€Œã‚ã‚Šã€ãªã‚‰è¿½åŠ ã§å¿…é ˆ
  const deviceFlow = needsDeviceFlow(curCtx.contractType);
  if (deviceFlow && curCtx.needDataTransfer === "yes") ids.push("chk_done_datatransfer");
  if (deviceFlow && curCtx.needTradeInReception === "yes") ids.push("chk_done_tradein");

  return ids;
}
function isS3SimChecklistComplete(curCtx){
  // SIMã®ã¿MNPãªã‚‰4ã¤å…¨éƒ¨å¿…é ˆ
  const ids = ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"];
  return ids.every(id => el(id) && el(id).checked);
}

function isS3NChecklistComplete(curCtx){
  const ids = ["chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"];

  // MNPã®ã¨ãã ã‘äºˆç´„ç•ªå·ã‚’å¿…é ˆã«ã™ã‚‹
  if (isMnp(curCtx.contractType)) ids.unshift("chk_s3n_mnp");

  return ids.every(id => el(id) && el(id).checked);
}

function isDoneChecklistComplete(curCtx){
  const ids = requiredDoneIds(curCtx);
  return ids.every(id => el(id) && el(id).checked);
}

function resetDoneChecklistUI(){
  const ids = ["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"];
  ids.forEach(id => { if (el(id)) el(id).checked = false; });

  if (el("doneDataTransferItem")) el("doneDataTransferItem").classList.add("hidden");
  if (el("doneTradeInItem")) el("doneTradeInItem").classList.add("hidden");
  if (el("doneChecklist")) el("doneChecklist").classList.add("hidden");
  if (el("finishBox")) el("finishBox").classList.add("hidden");
}

function render(){
  const bar = el("stepbar");
  bar.innerHTML = "";

  // æœªé–‹å§‹
  if (idx < 0){
    el("stepTitle").textContent = "é–‹å§‹ã—ã¦ãã ã•ã„";
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    el("backBtn").disabled = true;
    el("nextBtn").disabled = true;
    el("openConsultBtn").classList.add("hidden");
    return;
  }

  const STEPBAR_VISIBLE_IDS = ["S1","S2","S3","S3N","S3C","S4"];
  steps.forEach((s, i) => {
    if (!STEPBAR_VISIBLE_IDS.includes(s.id)) return;
    const d = document.createElement("div");
    d.className = "step" + (i === idx ? " current" : (i < idx ? " done" : ""));
    d.textContent = s.name;
    d.onclick = () => { idx = i; render(); saveFlowState(); };
    bar.appendChild(d);
  });

  const step = steps[idx];
  el("stepTitle").textContent = step.name;

  // S2ã ã‘ã‚³ãƒ³ã‚µãƒ«ãƒœã‚¿ãƒ³è¡¨ç¤º
  if (step.id === "S2") el("openConsultBtn").classList.remove("hidden");
  else el("openConsultBtn").classList.add("hidden");

  // S5: å®Œäº†ç”»é¢
  if (step.id === "S5"){
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.remove("hidden");

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = true;
    return;
  }
    // S3: SIMã®ã¿ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
  if (step.id === "S3" && ctx && ctx.contractType === "mnpSim"){
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");

    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");

    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
    el("s3SimChecklist").classList.remove("hidden");

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isS3SimChecklistComplete(ctx); // â˜…å…¨éƒ¨ãƒã‚§ãƒƒã‚¯ã¾ã§æ¬¡ã¸ç¦æ­¢
    return;
  } else {
    if (el("s3SimChecklist")) el("s3SimChecklist").classList.add("hidden");
  }
    // S3N: åˆ†ãƒªã‚»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
  if (step.id === "S3N"){
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");

    el("doneChecklist").classList.add("hidden");
    el("finishBox").classList.add("hidden");

    el("s3nChecklist").classList.remove("hidden");

    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isS3NChecklistComplete(ctx);
    return;
  } else {
    // S3Nä»¥å¤–ã§ã¯éš ã™
    if (el("s3nChecklist")) el("s3nChecklist").classList.add("hidden");
  }

  // S4: ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç”»é¢
  if (step.id === "S4"){
    el("warnBox").classList.add("hidden");
    el("nextBox").classList.add("hidden");
    el("finishBox").classList.add("hidden");
    el("doneChecklist").classList.remove("hidden");

    // ã‚³ãƒ³ã‚µãƒ«å…¥åŠ›ã«å¿œã˜ã¦è¡¨ç¤º
    el("doneDataTransferItem").classList.toggle("hidden", ctx.needDataTransfer !== "yes");
    el("doneTradeInItem").classList.toggle("hidden", ctx.needTradeInReception !== "yes");

    // S4ã¯ã€Œå¿…è¦ãªãƒã‚§ãƒƒã‚¯å…¨éƒ¨OKã€ã¾ã§æ¬¡ã¸ç¦æ­¢
    el("backBtn").disabled = (idx === 0);
    el("nextBtn").disabled = !isDoneChecklistComplete(ctx);
    return;
  }

  // S1ã€œS3ç³»: æ³¨æ„ãƒ»æ¬¡ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º
  el("doneChecklist").classList.add("hidden");
  el("finishBox").classList.add("hidden");

  const c = contentFor(step.id, ctx);

  const ul = el("warnList");
  ul.innerHTML = "";
  c.warn.forEach(t => {
    const li = document.createElement("li");
    li.textContent = t;
    if (t.startsWith("ã€è­¦å‘Šã€‘")) li.classList.add("red");
    ul.appendChild(li);
  });

  el("nextAction").textContent = c.next;

  el("warnBox").classList.remove("hidden");
  el("nextBox").classList.remove("hidden");

  el("backBtn").disabled = (idx === 0);
  el("nextBtn").disabled = (idx === steps.length - 1);
}

/* =========================
   Draft save/load (page fields)
   ========================= */
function collectForm(){
  return {
    contractType: el("contractType").value,
    ageType: el("ageType").value,
    userRelation: el("userRelation").value,
    idType: el("idType").value,
    carrier: el("carrier").value,
    deviceFrom: el("deviceFrom").value,
    dataUsage: el("dataUsage").value,
    usageYears: el("usageYears").value,
    homeNetType: el("homeNetType").value,
    homeNetYears: el("homeNetYears").value,
    chk_id_confirmed: el("chk_id_confirmed").checked,
    chk_homeNet_asked: el("chk_homeNet_asked").checked,
    chk_tradein: el("chk_tradein").checked,
    tradeinResult: (el("tradeinResult") ? el("tradeinResult").value : "")
  };
}

function saveDraft(){
  writeShared(collectForm()); // payTypeãªã©ã¯ä¿æŒï¼ˆmergeï¼‰
}

function loadDraft(){
  const data = readShared();
  const setVal = (id, v) => { if (v != null && el(id)) el(id).value = v; };

  setVal("contractType", data.contractType);
  updateTradeInVisibility();

  setVal("ageType", data.ageType);
  updateIdOptionsByAge();
  setVal("idType", data.idType);

  setVal("userRelation", data.userRelation);
  setVal("carrier", data.carrier);
  setVal("deviceFrom", data.deviceFrom);
  setVal("dataUsage", data.dataUsage);
  setVal("usageYears", data.usageYears);
  setVal("homeNetType", data.homeNetType);
  setVal("homeNetYears", data.homeNetYears);

  if (el("chk_id_confirmed")) el("chk_id_confirmed").checked = !!data.chk_id_confirmed;
  if (el("chk_homeNet_asked")) el("chk_homeNet_asked").checked = !!data.chk_homeNet_asked;
  if (el("chk_tradein")) el("chk_tradein").checked = !!data.chk_tradein;
  if (el("tradeinResult")) el("tradeinResult").value = data.tradeinResult || "";

  updateStartEnabled();
}

/* =========================
   Flow state save/restore
   ========================= */
function saveFlowState(){
  if (!ctx || idx < 0 || !steps[idx]) return;
  writeShared({
    [FLOW_STARTED_KEY]: true,
    [FLOW_STEPID_KEY]: steps[idx].id
  });
}

function clearFlowState(){
  writeShared({
    [FLOW_STARTED_KEY]: false,
    [FLOW_STEPID_KEY]: ""
  });
}

/* æˆ»ã£ã¦ããŸã‚‰ storage ã‹ã‚‰å¿…ãšå¾©å…ƒï¼†å†æ§‹ç¯‰ */
function syncFromStorage(){
  const shared = readShared();
  const payTypeKeep = shared.payType || "";   // â˜…å…ˆã«ç¢ºä¿

  // ãƒ•ã‚©ãƒ¼ãƒ ã¯å¸¸ã«æœ€æ–°ã¸
  loadDraft();

  const shared2 = readShared();
  const started = !!shared2[FLOW_STARTED_KEY];

  if (!started){
    ctx = null;
    steps = [];
    idx = -1;
    render();
    return;
  }

  ctx = {
    ...collectForm(),
    payType: payTypeKeep || (shared2.payType || ""),
    needDataTransfer: shared2.needDataTransfer || "no",
    needTradeInReception: shared2.needTradeInReception || "no",
  };

  steps = buildSteps(ctx.contractType, ctx.payType);

  const savedId = shared2[FLOW_STEPID_KEY] || "S1";
  let newIdx = steps.findIndex(s => s.id === savedId);

  // ä¿å­˜åœ°ç‚¹ãŒæ¶ˆãˆãŸï¼ˆpayTypeæœªæ±ºå®šã§S3ä»¥é™ãŒç„¡ã„ç­‰ï¼‰â†’S2ã¸
  if (newIdx < 0){
    newIdx = steps.findIndex(s => s.id === "S2");
    if (newIdx < 0) newIdx = 0;
  }

  idx = Math.max(0, Math.min(newIdx, steps.length - 1));
  render();
}

/* =========================
   Events
   ========================= */
const watchIds = ["contractType","ageType","idType","userRelation","carrier","usageYears","dataUsage","deviceFrom","homeNetType","homeNetYears"];
watchIds.forEach(id => {
  el(id).addEventListener("change", () => {
    if (id === "contractType") updateTradeInVisibility();
    if (id === "ageType") updateIdOptionsByAge();
    updateStartEnabled();
    saveDraft();
  });
});

["chk_id_confirmed","chk_homeNet_asked","chk_tradein"].forEach(id => {
  el(id).addEventListener("change", () => {
    updateStartEnabled();
    saveDraft();
  });
});

["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    if (steps[idx] && steps[idx].id === "S3" && ctx && ctx.contractType === "mnpSim") render();
  });
});

["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"].forEach(id => {
  const node = el(id);
  if (!node) return;
  node.addEventListener("change", () => {
    if (steps[idx] && steps[idx].id === "S3N") render();
  });
});

["chk_done_return","chk_done_open","chk_done_datatransfer","chk_done_point","chk_done_consent","chk_done_tradein","chk_done_car"]
  .forEach(id => {
    const node = el(id);
    if (!node) return;
    node.addEventListener("change", () => {
      if (steps[idx] && steps[idx].id === "S4") render();
    });
  });

if (el("tradeinResult")){
  el("tradeinResult").addEventListener("change", () => {
    updateStartEnabled();
    saveDraft();
  });
}

// start/reset
el("startBtn").onclick = () => {
  if (!allSelected()) return;

  // é–‹å§‹æ™‚ã«ã€Œè³¼å…¥æ–¹æ³•ã€ã‚’å¿…ãšãƒªã‚»ãƒƒãƒˆï¼ˆstorageå´ã‚‚æ¶ˆã™ï¼‰
  writeShared({
    payType: "",
    needDataTransfer: "no",
    needTradeInReception: "no",
  });

  const shared = readShared(); // ã“ã“ã§èª­ã‚€ shared ã¯æ—¢ã«ãƒªã‚»ãƒƒãƒˆå¾Œ

  ctx = {
    ...collectForm(),
    payType: "", // ctx ã‚‚å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
    needDataTransfer: shared.needDataTransfer || "no",
    needTradeInReception: shared.needTradeInReception || "no",
  };

  steps = buildSteps(ctx.contractType, ctx.payType);
  idx = 0;
  render();
  saveFlowState();
};

el("resetBtn").onclick = () => {
  ["contractType","ageType","idType","userRelation","carrier","usageYears","dataUsage","deviceFrom","homeNetType","homeNetYears"]
    .forEach(id => el(id).value = "");
  ["chk_id_confirmed","chk_homeNet_asked","chk_tradein"].forEach(id => el(id).checked = false);
  [
    "chk_done_return",
    "chk_done_open",
    "chk_done_datatransfer",
    "chk_done_point",
    "chk_done_consent",
    "chk_done_tradein"
  ].forEach(id => { const n = el(id); if (n) n.checked = false; });
  if (el("tradeinResult")) el("tradeinResult").value = "";
  ["chk_s3n_mnp","chk_s3n_apply","chk_s3n_prepare","chk_s3n_input","chk_s3n_video","chk_s3n_result"]
  .forEach(id => { const n = el(id); if (n) n.checked = false; });
  ["chk_s3sim_mnp","chk_s3sim_docs","chk_s3sim_input","chk_s3sim_notice"]
  .forEach(id => { const n = el(id); if (n) n.checked = false; });

  // å®Œäº†ãƒ–ãƒ­ãƒƒã‚¯ã®è¡¨ç¤ºã‚‚åˆæœŸåŒ–
  if (el("doneDataTransferItem")) el("doneDataTransferItem").classList.add("hidden");
  if (el("doneTradeInItem"))      el("doneTradeInItem").classList.add("hidden");
  if (el("doneChecklist"))        el("doneChecklist").classList.add("hidden");

  // payTypeã¯æ®‹ã™è¨­è¨ˆ
  writeShared({
    contractType:"", ageType:"", userRelation:"", idType:"",
    carrier:"", deviceFrom:"", dataUsage:"", usageYears:"",
    homeNetType:"", homeNetYears:"",
    chk_id_confirmed:false, chk_homeNet_asked:false, chk_tradein:false,
    tradeinResult:"",
    payType:"",
    needDataTransfer: "no",
    needTradeInReception: "no",
  });

  ctx = null;
  steps = [];
  idx = -1;

  updateTradeInVisibility();
  updateStartEnabled();
  render();
  clearFlowState();
};

// nav
el("backBtn").onclick = () => { if (idx > 0) { idx--; render(); saveFlowState(); } };
el("nextBtn").onclick = () => { if (idx < steps.length - 1) { idx++; render(); saveFlowState(); } };

// consult openï¼ˆä¿å­˜ã—ã¦ã‹ã‚‰é·ç§»ï¼‰
el("openConsultBtn").onclick = () => {
  saveDraft();
  saveFlowState();
  window.location.href = "ConsultingNavigator.html";
};

// helpï¼ˆreadmeã¸ï¼‰
if (el("helpBtn")){
  el("helpBtn").onclick = () => {
    window.location.href = "readme.html";
  };
}

// Chromeã®æˆ»ã‚‹(bfcache)å¯¾ç­–ï¼špageshowã§å¿…ãšåŒæœŸ
window.addEventListener("pageshow", () => syncFromStorage());
// ã‚¿ãƒ–å¾©å¸°
window.addEventListener("focus", () => syncFromStorage());
// åˆ¥ã‚¿ãƒ–æ›´æ–°
window.addEventListener("storage", (ev) => { if (ev.key === STORAGE_KEY) syncFromStorage(); });

/* =========================
   Init
   ========================= */
updateTradeInVisibility();
updateIdOptionsByAge();
updateStartEnabled();
syncFromStorage();
</script>
</body>
</html>